@using SPTarkov.Server.Core.Models.Eft.Common
@using SPTarkov.Server.Core.Models.Eft.Common.Tables
@using SPTarkov.Server.Core.Models.Enums
@using Color = MudBlazor.Color

@inject I18N I18N
@inject DataFormatService DataFormat;
@inject RecordManager RecordManager;


<MudPaper Class="pa-4">
    <MudCard>
        <MudCardContent>
            <MudText>@I18N.WebUILocal.BaseInfo</MudText>
            <MudText Typo="Typo.body2">
                ServerId: @Archive.ServerId
                @I18N.WebUILocal.ArchiveTime: @DataFormat.FromDateTimeSeconds(Archive.CreateTime)
                @I18N.WebUILocal.PlayerNickName: @PlayerData.Info?.Nickname
                @I18N.WebUILocal.PlayerLevel: @PlayerData.Info?.Level
                @I18N.WebUILocal.PlayerId: @Archive.PlayerId
            </MudText>
        </MudCardContent>
    </MudCard>
    <MudCard>
        <MudCardContent>
            <MudText>@I18N.WebUILocal.Link(I18N.WebUILocal.MapName, I18N.WebUILocal.And, I18N.WebUILocal.SurviveTime)</MudText>
            <MudText Typo="Typo.body2">
                @(I18N.WebUILocal.MapName): @DataFormat.GetMapNameLocal(Archive)
                @(I18N.WebUILocal.SurviveTime): @DataFormat.FromTimeSeconds(Archive.Results?.PlayTime ?? 0)
            </MudText>
        </MudCardContent>
    </MudCard>
    <MudCard>
        <MudCardContent>
            <MudText>@I18N.WebUILocal.ArchiveResult</MudText>
            <MudText Typo="Typo.body2">
                @I18N.WebUILocal.Result: @DataFormat.GetResultStr(Archive)
                @I18N.WebUILocal.ExitName: @DataFormat.GetExitName(Archive)
                @I18N.WebUILocal.SurvivorClass: @DataFormat.GetSurvivorClass(Archive)
            </MudText>
        </MudCardContent>
    </MudCard>
    <MudCard>
        <MudCardContent>
            <MudText>@I18N.WebUILocal.EnterArchive</MudText>
            <MudText Typo="Typo.body2">
                @I18N.WebUILocal.EquipmentValue: @Archive.EquipmentValue rub
                @I18N.WebUILocal.SecuredValue: @Archive.SecuredValue rub
                @I18N.WebUILocal.PreRaidValue: @Archive.PreRaidValue rub
            </MudText>
        </MudCardContent>
    </MudCard>
    <MudCard>
        <MudCardContent>
            <MudText>@I18N.WebUILocal.ExitArchive</MudText>
            <MudText Typo="Typo.body2">
                @I18N.WebUILocal.GrossProfit: @Archive.GrossProfit rub
                @I18N.WebUILocal.CombatLoss: @Archive.CombatLosses rub
                @I18N.WebUILocal.NetProfit: @DataFormat.GetNetProfit(Archive) rub
            </MudText>
        </MudCardContent>
    </MudCard>
    <MudCard>
        <MudCardContent>
            <MudText>@I18N.WebUILocal.KillInfo</MudText>
            <MudText Typo="Typo.body2">
                @(I18N.WebUILocal.KillCount): @DataFormat.GetKillCount(Archive)
                @(I18N.WebUILocal.HeadshotRate): @DataFormat.GetHeadshotRate(Archive)
            </MudText>
            @if (DataFormat.GetKillCount(Archive) > 0 && ShowToolZone)
            {
                @if (_showKillAll)
                {
                    <MudTable Items="@GetVictims()" FixedHeader="@true" FixedFooter="@true">
                        <HeaderContent>
                            <MudTh>@I18N.WebUILocal.Time</MudTh>
                            <MudTh>@I18N.WebUILocal.Weapon</MudTh>
                            <MudTh>@I18N.WebUILocal.BodyPart</MudTh>
                            <MudTh>@I18N.WebUILocal.Distance</MudTh>
                            <MudTh>@I18N.WebUILocal.VictimInfo</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@DataFormat.GetVictimTime(context)</MudTd>
                            <MudTd>@DataFormat.GetWeaponName(context)</MudTd>
                            <MudTd>@DataFormat.GetBodyPartName(context)</MudTd>
                            <MudTd>@DataFormat.GetDistance(context)</MudTd>
                            <MudTd>@($"{context.Name}(Lv{context.Level} side: {context.Side} role: {DataFormat.GetRoleName(context)})")</MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new[] { 10, 30 }"/>
                        </PagerContent>
                    </MudTable>
                }
                <MudCardActions>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => OnShowKillAllClick())">
                        @(_showKillAll ? I18N.WebUILocal.Link(I18N.WebUILocal.Collapse, I18N.WebUILocal.KillInfo) : I18N.WebUILocal.Link(I18N.WebUILocal.Expand, I18N.WebUILocal.KillInfo))
                    </MudButton>
                </MudCardActions>
            }
            @if (Archive.Results?.Result == ExitStatus.KILLED)
            {
                Aggressor? aggressor = Archive.EftStats?.Aggressor;
                if (aggressor != null)
                {
                    <MudCard>
                        <MudCardContent>
                            <MudText>@I18N.WebUILocal.AggressorInfo</MudText>
                            <MudText Typo="Typo.body2">
                                @I18N.WebUILocal.Name: @aggressor.Name
                                @I18N.WebUILocal.Side: @aggressor.Side
                                @I18N.WebUILocal.Link(I18N.WebUILocal.Weapon, I18N.WebUILocal.Name): @DataFormat.GetWeaponName(aggressor)
                                @I18N.WebUILocal.Role: @DataFormat.GetRoleName(aggressor)
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                }
                else
                {
                    <MudText>@I18N.WebUILocal.AggressorInfoLoadFail</MudText>
                }
            }
        </MudCardContent>
    </MudCard>

    @if (ShowToolZone)
    {
        <MudCard>
            <QuickEquipmentWidget Archive="Archive" ProvideQuickBuy="@true"/>
        </MudCard>

        <MudCard>
            <ItemsShowWidget Archive="Archive"/>
        </MudCard>
    }

    @code
    {
        PmcData PlayerData => RecordManager.GetPmcDataByPlayerId(Archive.PlayerId);

        bool _showKillAll;

        private void OnShowKillAllClick()
        {
            _showKillAll = !_showKillAll;
        }
    }
</MudPaper>

@code {
    [Parameter]
    public required RaidArchive Archive { get; set; }

    [Parameter] public bool ShowToolZone { get; set; } = true;

    public List<Victim> GetVictims() => Archive.EftStats?.Victims?.ToList() ?? [];
}