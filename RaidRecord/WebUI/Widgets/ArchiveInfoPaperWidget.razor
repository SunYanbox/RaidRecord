@using SPTarkov.Server.Core.Models.Eft.Common
@using SPTarkov.Server.Core.Models.Eft.Common.Tables
@using SPTarkov.Server.Core.Models.Enums
@using Color = MudBlazor.Color

@inject I18NMgr I18NMgr
@inject DataFormatService DataFormat;
@inject RecordManager RecordManager;


<MudPaper Class="pa-4">
    <MudCard>
        <MudCardContent>
            <MudText>@("webUI.baseInfo".Translate(I18NMgr.I18N!))</MudText>
            <MudText Typo="Typo.body2">
                ServerId: @Archive.ServerId
                @("webUI.archiveTime".Translate(I18NMgr.I18N!)): @DataFormat.FromDateTimeSeconds(Archive.CreateTime)
                @("webUI.playerNickName".Translate(I18NMgr.I18N!)): @PlayerData.Info?.Nickname
                @("webUI.playerLevel".Translate(I18NMgr.I18N!)): @PlayerData.Info?.Level
                @("webUI.playerId".Translate(I18NMgr.I18N!)): @Archive.PlayerId
            </MudText>
        </MudCardContent>
    </MudCard>
    <MudCard>
        <MudCardContent>
            <MudText>@("mapName::and::webUI.surviveTime".Translate(I18NMgr.I18N!))</MudText>
            <MudText Typo="Typo.body2">
                @("mapName".Translate(I18NMgr.I18N!)): @DataFormat.GetMapNameLocal(Archive)
                @("webUI.surviveTime".Translate(I18NMgr.I18N!)): @DataFormat.FromTimeSeconds(Archive.Results?.PlayTime ?? 0)
            </MudText>
        </MudCardContent>
    </MudCard>
    <MudCard>
        <MudCardContent>
            <MudText>@("webUI.archiveResult".Translate(I18NMgr.I18N!))</MudText>
            <MudText Typo="Typo.body2">
                @("result".Translate(I18NMgr.I18N!)): @DataFormat.GetResultStr(Archive)
                @("exitName".Translate(I18NMgr.I18N!)): @DataFormat.GetExitName(Archive)
                @("webUI.survivorClass".Translate(I18NMgr.I18N!)): @DataFormat.GetSurvivorClass(Archive)
            </MudText>
        </MudCardContent>
    </MudCard>
    <MudCard>
        <MudCardContent>
            <MudText>@("webUI.enterArchive".Translate(I18NMgr.I18N!))</MudText>
            <MudText Typo="Typo.body2">
                @("webUI.equipmentValue".Translate(I18NMgr.I18N!)): @Archive.EquipmentValue rub
                @("webUI.securedValue".Translate(I18NMgr.I18N!)): @Archive.SecuredValue rub
                @("webUI.preRaidValue".Translate(I18NMgr.I18N!)): @Archive.PreRaidValue rub
            </MudText>
        </MudCardContent>
    </MudCard>
    <MudCard>
        <MudCardContent>
            <MudText>@("webUI.exitArchive".Translate(I18NMgr.I18N!))</MudText>
            <MudText Typo="Typo.body2">
                @("grossProfit".Translate(I18NMgr.I18N!)): @Archive.GrossProfit rub
                @("combatLoss".Translate(I18NMgr.I18N!)): @Archive.CombatLosses rub
                @("netProfit".Translate(I18NMgr.I18N!)): @DataFormat.GetNetProfit(Archive) rub
            </MudText>
        </MudCardContent>
    </MudCard>
    <MudCard>
        <MudCardContent>
            <MudText>@("killInfo".Translate(I18NMgr.I18N!))</MudText>
            <MudText Typo="Typo.body2">
                @("killCount".Translate(I18NMgr.I18N!)): @DataFormat.GetKillCount(Archive)
                @("headshotRate".Translate(I18NMgr.I18N!)): @DataFormat.GetHeadshotRate(Archive)
            </MudText>
            @if (DataFormat.GetKillCount(Archive) > 0 && ShowToolZone)
            {
                @if (_showKillAll)
                {
                    <MudTable Items="@GetVictims()" FixedHeader="@true" FixedFooter="@true">
                        <HeaderContent>
                            <MudTh>@("time".Translate(I18NMgr.I18N!))</MudTh>
                            <MudTh>@("weapon".Translate(I18NMgr.I18N!))</MudTh>
                            <MudTh>@("bodyPart".Translate(I18NMgr.I18N!))</MudTh>
                            <MudTh>@("distance".Translate(I18NMgr.I18N!))</MudTh>
                            <MudTh>@("webUI.victimInfo".Translate(I18NMgr.I18N!))</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@DataFormat.GetVictimTime(context)</MudTd>
                            <MudTd>@DataFormat.GetWeaponName(context)</MudTd>
                            <MudTd>@DataFormat.GetBodyPartName(context)</MudTd>
                            <MudTd>@DataFormat.GetDistance(context)</MudTd>
                            <MudTd>@($"{context.Name}(Lv{context.Level} side: {context.Side} role: {DataFormat.GetRoleName(context)})")</MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new[] { 10, 30 }"/>
                        </PagerContent>
                    </MudTable>
                }
                <MudCardActions>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => OnShowKillAllClick())">
                        @(_showKillAll ? "collapse::killInfo".Translate(I18NMgr.I18N!) : "expand::killInfo".Translate(I18NMgr.I18N!))
                    </MudButton>
                </MudCardActions>
            }
            @if (Archive.Results?.Result == ExitStatus.KILLED)
            {
                Aggressor? aggressor = Archive.EftStats?.Aggressor;
                if (aggressor != null)
                {
                    <MudCard>
                        <MudCardContent>
                            <MudText>@("webUI.aggressorInfo".Translate(I18NMgr.I18N!))</MudText>
                            <MudText Typo="Typo.body2">
                                @("name".Translate(I18NMgr.I18N!)): @aggressor.Name
                                @("side".Translate(I18NMgr.I18N!)): @aggressor.Side
                                @("weapon::name".Translate(I18NMgr.I18N!)): @DataFormat.GetWeaponName(aggressor)
                                @("role".Translate(I18NMgr.I18N!)): @DataFormat.GetRoleName(aggressor)
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                }
                else
                {
                    <MudText>@("webUI.aggressorInfoLoadFail".Translate(I18NMgr.I18N!))</MudText>
                }
            }
        </MudCardContent>
    </MudCard>

    @if (ShowToolZone)
    {
        <MudCard>
            <QuickEquipmentWidget Archive="Archive" ProvideQuickBuy="@true"/>
        </MudCard>

        <MudCard>
            <ItemsShowWidget Archive="Archive"/>
        </MudCard>
    }

    @code
    {
        PmcData PlayerData => RecordManager.GetPmcDataByPlayerId(Archive.PlayerId);

        bool _showKillAll;

        private void OnShowKillAllClick()
        {
            _showKillAll = !_showKillAll;
        }
    }
</MudPaper>

@code {
    [Parameter]
    public required RaidArchive Archive { get; set; }

    [Parameter] public bool ShowToolZone { get; set; } = true;

    public List<Victim> GetVictims() => Archive.EftStats?.Victims?.ToList() ?? [];
}