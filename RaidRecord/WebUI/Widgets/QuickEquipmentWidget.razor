@using RaidRecord.Core.Models.Tree
@using SPTarkov.Server.Core.Models.Common
@using SPTarkov.Server.Core.Models.Eft.Common
@using SPTarkov.Server.Core.Models.Eft.Common.Tables
@using SPTarkov.Server.Core.Models.Eft.ItemEvent
@using Color = MudBlazor.Color

@inject I18N I18N
@inject ISnackbar Snackbar
@inject ModConfig ModConfig
@inject ItemHelper ItemHelper
@inject PriceSystem PriceSystem
@inject DataGetterService DataGetter
@inject ModMailService ModMailService
@inject WebDataContext WebDataContext
@inject AlgorithmService AlgorithmService

<MudPaper Class="pa-16 ma-2" Outlined="true">
    <MudText Typo="Typo.h4">@I18N.WebUILocal.EquipmentInfo</MudText>
    <MudSpacer/>
    @if (_initEd)
    {
        <MudStack>
            <MudStack Row="true">
                <MudText Typo="Typo.body1">@(I18N.WebUILocal.ChoiceTotalValue):</MudText>
                <MudText Color="Color.Info">@(GetChoiceAllPriceFormat())</MudText>
                @if (TreeView is not null)
                {
                    <MudButton Color="Color.Primary" OnClick="@(() => TreeView.ExpandAllAsync())" Variant="Variant.Text">@I18N.WebUILocal.Link(I18N.WebUILocal.Expand, I18N.WebUILocal.All)</MudButton>
                    <MudButton Color="Color.Dark" OnClick="@(() => TreeView.CollapseAllAsync())" Variant="Variant.Text">@I18N.WebUILocal.Link(I18N.WebUILocal.Collapse, I18N.WebUILocal.All)</MudButton>
                }
            
                @if (ProvideQuickBuy)
                {
                    <MudButton
                        StartIcon="@Icons.Material.Filled.Payment"
                        Disabled="@(GetChoiceAllPrice() <= 0)"
                        OnClick="@(() => QuickBuyEquipmentMegBox.ShowAsync())">
                        @I18N.WebUILocal.NowPayment
                    </MudButton>
                }
            </MudStack>
            <MudStack Row="true">
                <MudSwitch @bind-Value="LabelSwitchWeapon" Label="@I18N.WebUILocal.Weapon" Color="Color.Success"/>
                <MudSwitch @bind-Value="LabelSwitchWeaponMod" Label="@I18N.WebUILocal.WeaponMod" Color="Color.Success"/>
                <MudSwitch @bind-Value="LabelSwitchHead" Label="@I18N.WebUILocal.Head" Color="Color.Success"/>
                <MudSwitch @bind-Value="LabelSwitchArmor" Label="@I18N.WebUILocal.Armor" Color="Color.Success"/>
                <MudSwitch @bind-Value="LabelSwitchVest" Label="@I18N.WebUILocal.Vest" Color="Color.Success"/>
                <MudSwitch @bind-Value="LabelSwitchBackpack" Label="@I18N.WebUILocal.Backpack" Color="Color.Success"/>
                <MudSwitch @bind-Value="LabelSwitchEquipmentMod" Label="@I18N.WebUILocal.EquipMod" Color="Color.Success"/>
            </MudStack>
        </MudStack>

        @if (Equipments.Length == 0)
        {
            <MudAlert Color="Color.Warning">@I18N.WebUILocal.NoEquipInfoInThisArchive</MudAlert>
        }
        else
        {
            <MudTreeView @ref="TreeView" MaxHeight="400px" Class="overflow-y-auto" Items="@TreeItems" ReadOnly="@true" Hover="@true" Dense="@true" ExpandOnClick="@true">
                <ItemTemplate>
                    @{
                        RRTreeItemData presenter = context as RRTreeItemData 
                                                   ?? throw new InvalidOperationException("RRTreeItemData is null");
                        <MudTreeViewItem
                            @bind-Expanded="@presenter.Expanded"
                            Items="@presenter.Children?.AsReadOnly()"
                            Value="@presenter.Value"
                            Icon="@presenter.Icon"
                            Text="@presenter.Text"
                            EndText="@GetEndText(presenter)"
                            EndTextTypo="@Typo.caption"
                            Disabled="@IsNodeDisable(presenter.ItemId)"/>
                    }
                </ItemTemplate>
            </MudTreeView>
        }
    }
    else
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7"/>
    }
</MudPaper>

<MudMessageBox @ref="QuickBuyEquipmentMegBox" Title="Info" CancelText="@I18N.WebUILocal.Cancel">
    <MessageContent>
        <MudText Typo="Typo.body2" Color="Color.Info">
            @I18N.DumpFormatStrLocal(I18N.WebUILocal.BeforePaymentTip, new { TotalPrice = GetChoiceAllPrice() })
        </MudText>
    </MessageContent>

    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.Commit"
                   OnClick="@(() => QuickBuy())">@I18N.WebUILocal.ConfirmPayment
        </MudButton>
    </YesButton>
</MudMessageBox>

@code {
    /// <summary> 存档 </summary>
    [Parameter] public required RaidArchive Archive { get; set; }
    /// <summary> 是否提供快速购买按钮 </summary>
    [Parameter] public bool ProvideQuickBuy { get; set; }
    /// <summary> 初始化的异步延迟 用来避免其他控件卡住 </summary>
    [Parameter] public int InitDelay { get; set; } = 200;

    /// <summary> 控制是否需要构建树 </summary>
    private bool _needInitTree = true;
    /// <summary> ref MudMessageBox </summary>
    public required MudMessageBox QuickBuyEquipmentMegBox;
    /// <summary> ref MudTreeView </summary>
    public required MudTreeView<MongoId>? TreeView;
    /// <summary> 用于延迟数据加载 </summary>
    private bool _initEd;
    private bool LabelSwitchWeapon { get; set; } = true;
    private bool LabelSwitchWeaponMod { get; set; } = true;
    private bool LabelSwitchHead { get; set; } = true;
    private bool LabelSwitchArmor { get; set; } = true;
    private bool LabelSwitchBackpack { get; set; } = true;
    private bool LabelSwitchVest { get; set; } = true;
    private bool LabelSwitchEquipmentMod { get; set; } = true;
    
    protected override void OnParametersSet()
    {
        _needInitTree = true;
    }
    
    /// <summary> 物品节点树 </summary>
    private List<TreeNode<Item>>? _treeItems;
    /// <summary> ID->节点的映射 </summary>
    private Dictionary<MongoId, TreeNode<Item>>? _treeItemsMap;
    /// <summary> 给MudTreeView使用的 </summary>
    private List<RRTreeItemData>? _treeItemsMud;
    
    public List<RRTreeItemData> TreeItems => GetTreeItems();

    /// <summary>
    /// 初始化树节点 除非把_needInitTree设置为true, 否则不会初始化
    /// </summary>
    public void InitAllTree()
    {
        if (_needInitTree)
        {
            _treeItems = null;
            _treeItemsMap = null;
            _treeItemsMud = null;
            _needInitTree = false;
        }
        if (_treeItems == null || _treeItemsMap == null)
        {
            (_treeItems, _treeItemsMap) = 
                AlgorithmService.GetTreeItems(Archive.EquipmentItems ?? []);
        }
        _treeItemsMud ??= AlgorithmService.ConvertToTreeItems(_treeItems);
    }
    
    public List<RRTreeItemData> GetTreeItems()
    {
        InitAllTree();
        return _treeItemsMud!;
    }
    
    public void QuickBuy()
    {
        Item[] items = GetChoiceItems();
        double totalPrice = GetChoiceAllPrice();
        PmcData? pmcData = DataGetter.GetPmcData(WebDataContext.CurrAccount);
        if (pmcData == null | items.Length <= 0)
        {
            ModConfig.Warn("购买物品失败: 玩家数据获取失败");
            return;
        }
        List<Warning>? warnings = ModMailService.Payment(WebDataContext.CurrAccount, Convert.ToInt64(totalPrice), pmcData);

        if (warnings?.Count > 0)
        {
            ModConfig.Warn($"购买物品失败: {string.Join("\n", warnings.Select(x => x.ErrorMessage))}");
            return;
        }
        
        string buySuccess = I18N.DumpFormatStrLocal(I18N.WebUILocal.SuccessBuyItemMsg,
        new {
            Name = I18N.DumpFormatStrLocal(I18N.WebUILocal.EquipOwn, new { Archive.ServerId }),
            StackObjectsCount = items.Length,
            TotalPrice = totalPrice
        });

        List<Warning>? warnings2 = ModMailService.SendItemsToPlayer(
        WebDataContext.CurrAccount,
        buySuccess,
        items.ToList());

        if (warnings2?.Count > 0)
        {
            ModConfig.Warn($"发送物品失败: {string.Join("\n", warnings2.Select(x => x.ErrorMessage))}; 将回退扣费");
            List<Warning>? warnings3 = ModMailService.SendMoney(WebDataContext.CurrAccount, "回退资金", totalPrice);

            if (warnings3?.Count > 0)
            {
                ModConfig.Warn($"回退资金失败, 我也没招了: {string.Join("\n", warnings3.Select(x => x.ErrorMessage))}");
            }
            return;
        }
        Snackbar.Add(buySuccess);
    }

    protected async override Task OnInitializedAsync()
    {
        if (!_initEd)
        {
            await Task.Delay(InitDelay);
            _initEd = true;
        }
        await base.OnInitializedAsync();
    }

    /// <summary>获取所有选择的物品</summary>
    public Item[] GetChoiceItems() => Equipments.Where(item => !IsNodeDisable(item.Id)).ToArray();

    /// <summary> 获取所有选择的物品总价值 </summary>
    public double GetChoiceAllPrice()
    {
        return GetChoiceItems().Sum(x => PriceSystem.GetItemValueWithCache(x.Template));
    }

    /// <summary> 获取所有选择的物品总价的字符串 </summary>
    public string GetChoiceAllPriceFormat() => $"{GetChoiceAllPrice():F2}rub";

    private string GetEndText(RRTreeItemData node) => $"{PriceSystem.GetItemValueWithCache(node.TplId):F2}rub";

    public Item[] Equipments => Archive.EquipmentItems ?? [];

    /// <summary> 判断节点是否禁用 </summary>
    /// <param name="itemId">节点ID, 不可以是TempleID</param>
    public bool IsNodeDisable(MongoId itemId)
    {
        if (_treeItemsMap is null) InitAllTree();
        if (!_treeItemsMap!.TryGetValue(itemId, out TreeNode<Item>? node)) return true;
        if (IsTplClassNotChoice(node.Data.Template)) return true;
        MongoId? parent = node.ParentId;
        while (parent != null)
        {
            if (!_treeItemsMap!.TryGetValue(parent.Value, out TreeNode<Item>? nodeParent)) 
                continue;
            if (IsTplClassNotChoice(nodeParent.Data.Template)) return true;
            parent = nodeParent.ParentId;
        }
        return false;
    }

    /// <summary> 判断模板ID是否禁用 </summary>
    public bool IsTplClassNotChoice(MongoId tpl)
    {
        if (!LabelSwitchWeapon && ItemHelper.IsOfBaseclasses(tpl, DataGetter.WeaponClassesAlls)) return true;

        if (!LabelSwitchWeaponMod && ItemHelper.IsOfBaseclasses(tpl, DataGetter.WeaponModClassesAll)) return true;
        
        if (!LabelSwitchHead && ItemHelper.IsOfBaseclasses(tpl, DataGetter.HeadClassesAlls)) return true;
        
        if (!LabelSwitchArmor && ItemHelper.IsOfBaseclasses(tpl, DataGetter.ArmorClassesAlls)) return true;
        
        if (!LabelSwitchVest && ItemHelper.IsOfBaseclasses(tpl, DataGetter.VestClassesAlls)) return true;
        
        if (!LabelSwitchBackpack && ItemHelper.IsOfBaseclasses(tpl, DataGetter.BackpackClassesAlls)) return true;
        
        if (!LabelSwitchEquipmentMod && ItemHelper.IsOfBaseclasses(tpl, DataGetter.EquipmentModClassesAll)) return true;
        
        return false;
    }
}