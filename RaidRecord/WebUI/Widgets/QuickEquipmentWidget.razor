@using RaidRecord.Core.Models.Tree
@using SPTarkov.Server.Core.Models.Common
@using SPTarkov.Server.Core.Models.Eft.Common
@using SPTarkov.Server.Core.Models.Eft.Common.Tables
@using SPTarkov.Server.Core.Models.Eft.ItemEvent
@using SPTarkov.Server.Core.Utils.Cloners
@using Color=MudBlazor.Color

@inject I18N I18N
@inject ICloner Cloner
@inject ISnackbar Snackbar
@inject ModConfig ModConfig
@inject ItemHelper ItemHelper
@inject PriceSystem PriceSystem
@inject DataGetterService DataGetter
@inject ModMailService ModMailService
@inject WebDataContext WebDataContext
@inject AlgorithmService AlgorithmService

<MudPaper Outlined="true" MaxHeight="@MaxHeight" Class="overflow-y-auto pa-16 ma-2">
    @if (NeedRebuildTree)
    {
        RebuildTree();
    }
    @if (!_initEd)
    {
        // 没加载完毕显示一个占位框
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="800px" Height="@MaxHeight"/>
    }
    else if (_initEd && Items.Length == 0)
    {
        // 没加载完毕显示一个占位框
        <MudText Style="max-height: 50px; max-width: 800px">@I18N.WebUILocal.NoEquipInfoInThisArchive</MudText>
    }
    else
    {
        <MudStack Row="true" AlignItems="AlignItems.Center">
            <MudButton Color="Color.Primary" OnClick="@(() => ExpandAllAsync())">@I18N.WebUILocal.Link(I18N.WebUILocal.Expand, I18N.WebUILocal.All)</MudButton>
            <MudButton Color="Color.Primary" OnClick="@(() => CollapseAllAsync())">@I18N.WebUILocal.Link(I18N.WebUILocal.Collapse, I18N.WebUILocal.All)</MudButton>
            <MudText>@(I18N.WebUILocal.Link(I18N.WebUILocal.ChoiceTotalValue, GetAllPriceText()))</MudText>
            @if (ProvideQuickBuy)
            {
                <MudButton StartIcon="@Icons.Material.Filled.Payment" OnClick="@(() => RefQuickBuyEquipmentMegBox!.ShowAsync())">@I18N.WebUILocal.ConfirmPayment</MudButton>
            }
            @if (IsRepair)
            {
                <MudIcon Icon="@Icons.Material.Filled.AutoFixHigh"/>
                <MudText>@I18N.WebUILocal.AlreadyEnableDurabilityRepair</MudText>
            }
        </MudStack>
        <MudStack Row="true">
            <MudSwitch @bind-Value="@EnabledItemTypes[ItemType.Weapon]" Label="@I18N.WebUILocal.Weapon" Color="Color.Success"/>
            <MudSwitch @bind-Value="@EnabledItemTypes[ItemType.WeaponMod]" Label="@I18N.WebUILocal.WeaponMod" Color="Color.Success"/>
            <MudSwitch @bind-Value="@EnabledItemTypes[ItemType.Head]" Label="@I18N.WebUILocal.Head" Color="Color.Success"/>
            <MudSwitch @bind-Value="@EnabledItemTypes[ItemType.Armor]" Label="@I18N.WebUILocal.Armor" Color="Color.Success"/>
            <MudSwitch @bind-Value="@EnabledItemTypes[ItemType.Vest]" Label="@I18N.WebUILocal.Vest" Color="Color.Success"/>
            <MudSwitch @bind-Value="@EnabledItemTypes[ItemType.Backpack]" Label="@I18N.WebUILocal.Backpack" Color="Color.Success"/>
            <MudSwitch @bind-Value="@EnabledItemTypes[ItemType.EquipmentMod]" Label="@I18N.WebUILocal.EquipMod" Color="Color.Success"/>
        </MudStack>
        <MudTreeView @ref="RefTreeView" Items="@TreeItemsMud" Height="@MaxHeight"
                     ReadOnly="@true" Hover="@true" Dense="@true" ExpandOnClick="@true">
            <ItemTemplate>
                @{
                    RRTreeItemData presenter = context as RRTreeItemData
                                               ?? throw new InvalidOperationException("RRTreeItemData is null");
                    MongoId itemId = presenter.ItemId;
                    double modify = ItemHelper.GetItemQualityModifier(TreeItemsMap![itemId].Data);
                    Color widgetColor = GetWidgetColor(!IsNodeDisable(itemId));
                    <MudTreeViewItem
                        @bind-Expanded="@presenter.Expanded"
                        Items="@presenter.Children?.AsReadOnly()"
                        Value="@itemId"
                        Icon="@presenter.Icon">
                        <Content>
                            <MudStack Row="true">
                                @* 展开 / 折叠按钮 *@
                                <MudTreeViewItemToggleButton @bind-Expanded="@presenter.Expanded" Visible="@(presenter.Children?.Count > 0)"/>
                                @* 显示的名称与价格 *@
                                <MudText Color="@widgetColor">
                                    @I18N.WebUILocal.Link(presenter.Text!, GetNodePriceEndText(presenter))
                                </MudText>
                                @* 显示耐久 *@
                                <MudText Color="@widgetColor" Typo="Typo.caption">
                                    @($"x {modify:F4}")
                                </MudText>
                            </MudStack>
                        </Content>
                    </MudTreeViewItem>
                }
            </ItemTemplate>
        </MudTreeView>
    }
</MudPaper>

<MudMessageBox @ref="RefQuickBuyEquipmentMegBox" Title="Info" CancelText="@I18N.WebUILocal.Cancel">
    <MessageContent>
        <MudText Typo="Typo.body2" Color="Color.Info">
            @I18N.DumpFormatStrLocal(I18N.WebUILocal.BeforePaymentTip, new { TotalPrice = GetChoiceAllPrice() })
        </MudText>
    </MessageContent>

    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.Commit"
                   OnClick="@(() => QuickBuy())">@I18N.WebUILocal.ConfirmPayment
        </MudButton>
    </YesButton>
</MudMessageBox>

@code {
    // 对外属性
    /// <summary> 存档 </summary>
    [Parameter] public required RaidArchive Archive { get; set; }
    /// <summary> 初始化的异步延迟 用来避免其他控件卡住 </summary>
    [Parameter] public int InitDelay { get; set; } = 200;
    /// <summary> 是否提供快速购买按钮 </summary>
    [Parameter] public bool ProvideQuickBuy { get; set; } = true;
    /// <summary> 控件显示的最大高度 </summary>
    [Parameter] public string MaxHeight { get; set; } = "500px";
    /// <summary> 启用的物品的颜色 </summary>
    [Parameter] public Color EnableColor { get; set; } = Color.Info;
    /// <summary> 排除的物品的颜色 </summary>
    [Parameter] public Color ExcludeColor { get; set; } = Color.Error;

    private bool _isRepair;
    protected bool NeedRebuildTree;

    /// <summary> 是否修复物品耐久 </summary>
    protected bool IsRepair
    {
        get => _isRepair;
        set
        {
            if (_isRepair == value) return;
            NeedRebuildTree = true;
            _isRepair = value;
        }
    }

    /// <summary> 对局ServerId(必须提供) </summary>
    protected string ServerId => Archive.ServerId;

    /// <summary> 原始物品列表 </summary>
    protected Item[]? OriginalItems;

    /// <summary> 修复后的物品列表 </summary>
    protected Item[]? RepairItems;

    protected void RebuildTree()
    {
        OriginalItems = Archive.EquipmentItems ?? [];
        RepairItems = GetRepairItems(OriginalItems).ToArray();
        (TreeItems, TreeItemsMap) = AlgorithmService.GetTreeItems(Items);
        TreeItemsMud = AlgorithmService.ConvertToTreeItems(TreeItems);
        NeedRebuildTree = false;
    }

    /// <summary> 物品列表(必须提供) </summary>
    protected Item[] Items => IsRepair ? RepairItems! : OriginalItems!;

    /// <summary> ref MudMessageBox </summary>
    protected MudMessageBox? RefQuickBuyEquipmentMegBox;

    /// <summary> ref MudTreeView </summary>
    protected MudTreeView<MongoId>? RefTreeView;

    /// <summary> 修复物品列表 </summary>
    protected IEnumerable<Item> GetRepairItems(IEnumerable<Item> items)
    {
        // 创建副本
        items = items.Select(x => Cloner.Clone(x)) // 创建副本
            .Where(x => x is not null) // 排除空值
            .Cast<Item>(); // 强制转换
        // 修复物品耐久
        IEnumerable<Item> repairItems = items as Item[] ?? items.ToArray();
        foreach (Item item in repairItems)
        {
            // ModConfig.Info($"Repairing item: {item.Template}");
            TemplateItem? itemDetails = ItemHelper.GetItem(item.Template).Value;
            if (itemDetails?.Properties is null)
            {
                ModConfig.Warn($"Item: {item.Template} lacks properties, cannot ascertain quality level, assuming 100%");
                continue;
            }
            if (item.Upd is null) continue;
            TemplateItemProperties itemProperties = itemDetails.Properties;
            if (item.Upd.MedKit is not null)
            {
                // Meds
                item.Upd.MedKit.HpResource = itemProperties.MaxHpResource;
            }
            else if (item.Upd.Repairable is not null)
            {
                double? maxPossibleDurability = itemProperties.MaxDurability ?? item.Upd.Repairable.MaxDurability;
                item.Upd.Repairable.Durability = maxPossibleDurability;
            }
            else if (item.Upd.FoodDrink is not null)
            {
                item.Upd.FoodDrink.HpPercent = itemProperties.MaxResource;
            }
            else if (item.Upd.Key?.NumberOfUsages > 0 && itemProperties.MaximumNumberOfUsage > 0)
            {
                // keys - keys count upwards, not down like everything else
                int? maxNumOfUsages = itemProperties.MaximumNumberOfUsage.GetValueOrDefault(0);
                item.Upd.Key.NumberOfUsages = maxNumOfUsages;
            }
            else if (item.Upd.Resource?.UnitsConsumed > 0) // Item is less than 100% usage
            {
                // E.g. fuel tank
                item.Upd.Resource.Value = itemProperties.MaxResource;
            }
            else if (item.Upd.RepairKit is not null)
            {
                item.Upd.RepairKit.Resource = itemProperties.MaxRepairResource;
            }
        }
        return repairItems;
    }

    /// <summary>获取所有选择的可用物品(未排除的)</summary>
    public IEnumerable<Item> GetChoiceEnableItems()
    {
        return Items
            .Where(item => !IsNodeDisable(item.Id))
            .Select(x => Cloner.Clone(x)) // 创建副本
            .Where(x => x is not null) // 排除空值
            .Cast<Item>(); // 强制转换
    }

    /// <summary>获取当前节点物品的价值</summary>
    private double GetNodePrice(RRTreeItemData node)
    {
        double baseValue = PriceSystem.GetItemValueWithCache(node.TplId);
        if (!TreeItemsMap!.TryGetValue(node.ItemId, out TreeNode<Item>? nodeItem)) return 0;
        double modify = ItemHelper.GetItemQualityModifier(nodeItem.Data);
        if (IsRepair) return baseValue;
        return baseValue * modify;
    }

    /// <summary> 展开所有节点 </summary>
    public async Task ExpandAllAsync()
    {
        await RefTreeView!.ExpandAllAsync();
    }

    /// <summary> 收缩所有节点 </summary>
    public async Task CollapseAllAsync()
    {
        await RefTreeView!.CollapseAllAsync();
    }

    private string GetAllPriceText() => $"{GetChoiceAllPrice():F2}rub";

    private string GetNodePriceEndText(RRTreeItemData node) => $"{GetNodePrice(node):F2}rub";

    private Color GetWidgetColor(bool isEnable) => isEnable ? EnableColor : ExcludeColor;

    public enum ItemType
    {
        /// <summary> 武器 </summary>
        Weapon,

        /// <summary> 武器配件 </summary>
        WeaponMod,

        /// <summary> 头部装备 </summary>
        Head,

        /// <summary> 护甲 </summary>
        Armor,

        /// <summary> 胸挂 </summary>
        Vest,

        /// <summary> 背包 </summary>
        Backpack,

        /// <summary> 配件 </summary>
        EquipmentMod
    }

    /// <summary> 启用的物品类型 </summary>
    public readonly Dictionary<ItemType, bool> EnabledItemTypes = Enum.GetValues<ItemType>().ToDictionary(x => x, _ => true);

    /// <summary> 物品节点树 </summary>
    protected List<TreeNode<Item>>? TreeItems;

    /// <summary> ID->节点的映射 </summary>
    protected Dictionary<MongoId, TreeNode<Item>>? TreeItemsMap;

    /// <summary> 给MudTreeView使用的缓存 </summary>
    protected List<RRTreeItemData>? TreeItemsMud;

    /// <summary> 用于确认初始化延迟是否结束 </summary>
    private bool _initEd;

    /// <summary> 判断一个ItemId对应的节点是否被排除 </summary>
    private bool IsNodeDisable(MongoId itemId)
    {
        return !TreeItemsMap!.TryGetValue(itemId, out TreeNode<Item>? itemNode)
               || AnyFatherClassesExclude(itemNode);
    }

    /// <summary> 判断一个节点或他的任意一个父节点的模板ID分类被排除 </summary>
    private bool AnyFatherClassesExclude(TreeNode<Item> node)
    {
        return AnyFatherNode(node, treeNode => IsClassesExclude(treeNode.Data.Template));

        bool IsClassesExclude(MongoId tplId)
        {
            if (!EnabledItemTypes[ItemType.Weapon] && ItemHelper.IsOfBaseclasses(tplId, DataGetter.WeaponClassesAlls)) return true;

            if (!EnabledItemTypes[ItemType.WeaponMod] && ItemHelper.IsOfBaseclasses(tplId, DataGetter.WeaponModClassesAll)) return true;

            if (!EnabledItemTypes[ItemType.Head] && ItemHelper.IsOfBaseclasses(tplId, DataGetter.HeadClassesAlls)) return true;

            if (!EnabledItemTypes[ItemType.Armor] && ItemHelper.IsOfBaseclasses(tplId, DataGetter.ArmorClassesAlls)) return true;

            if (!EnabledItemTypes[ItemType.Vest] && ItemHelper.IsOfBaseclasses(tplId, DataGetter.VestClassesAlls)) return true;

            if (!EnabledItemTypes[ItemType.Backpack] && ItemHelper.IsOfBaseclasses(tplId, DataGetter.BackpackClassesAlls)) return true;

            if (!EnabledItemTypes[ItemType.EquipmentMod] && ItemHelper.IsOfBaseclasses(tplId, DataGetter.EquipmentModClassesAll)) return true;

            return false;
        }
    }

    /// <summary> 判断一个节点或他的任意一个父节点是否满足条件 </summary>
    private bool AnyFatherNode(TreeNode<Item> node, Func<TreeNode<Item>, bool> predicate)
    {
        if (predicate(node)) return true;
        MongoId? fatherId = node.ParentId;
        while (fatherId != null)
        {
            if (!TreeItemsMap!.TryGetValue(fatherId.Value, out TreeNode<Item>? fatherNode))
                return false;
            if (predicate(fatherNode)) return true;
            fatherId = fatherNode.ParentId;
        }
        return false;
    }

    protected async override Task OnInitializedAsync()
    {
        if (!_initEd)
        {
            await Task.Delay(InitDelay);
            try
            {
                RebuildTree();
                _initEd = true;
                IsRepair = ModConfig.Configs.IsRepairDurability;
            }
            catch (Exception e)
            {
                ModConfig.Error($"ItemTreeViewWidget在OnInitializedAsync中初始化时出错: ", e);
                throw;
            }
        }
        await base.OnInitializedAsync();
    }

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        IsRepair = ModConfig.Configs.IsRepairDurability;
        await base.OnAfterRenderAsync(firstRender);
    }

    private double GetChoiceAllPrice()
    {
        return GetChoiceEnableItems().Sum(x => PriceSystem.GetItemValueWithCache(x));
    }

    private void QuickBuy()
    {
        Item[] items = GetChoiceEnableItems().ToArray();
        double totalPrice = GetChoiceAllPrice();
        PmcData? pmcData = DataGetter.GetPmcData(WebDataContext.CurrAccount);
        if (pmcData == null | items.Length <= 0)
        {
            ModConfig.Warn("购买物品失败: 玩家数据获取失败");
            return;
        }
        List<Warning>? warnings = ModMailService.Payment(WebDataContext.CurrAccount, Convert.ToInt64(totalPrice), pmcData);

        if (warnings?.Count > 0)
        {
            ModConfig.Warn($"购买物品失败: {string.Join("\n", warnings.Select(x => x.ErrorMessage))}");
            return;
        }

        string buySuccess = I18N.DumpFormatStrLocal(I18N.WebUILocal.SuccessBuyItemMsg,
        new {
            Name = I18N.DumpFormatStrLocal(I18N.WebUILocal.EquipOwn, new {
                ServerId
            }),
            StackObjectsCount = items.Length,
            TotalPrice = totalPrice
        });

        List<Warning>? warnings2 = ModMailService.SendItemsToPlayer(WebDataContext.CurrAccount,
        buySuccess,
        items.ToList());

        if (warnings2?.Count > 0)
        {
            ModConfig.Warn($"发送物品失败: {string.Join("\n", warnings2.Select(x => x.ErrorMessage))}; 将回退扣费");
            List<Warning>? warnings3 = ModMailService.SendMoney(WebDataContext.CurrAccount, "回退资金", totalPrice);

            if (warnings3?.Count > 0)
            {
                ModConfig.Warn($"回退资金失败, 我也没招了: {string.Join("\n", warnings3.Select(x => x.ErrorMessage))}");
            }
            return;
        }
        Snackbar.Add(buySuccess);
    }
}