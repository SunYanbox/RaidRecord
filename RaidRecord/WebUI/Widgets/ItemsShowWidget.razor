@using SPTarkov.Server.Core.Models.Common
@using Color = MudBlazor.Color
@inject I18NMgr I18NMgr
@inject PriceSystem PriceSystem

<MudPaper Class="pa-16 ma-2" Outlined="true">
    <MudText Typo="Typo.h4">@("item::change::info".Translate(I18NMgr.I18N!))</MudText>
    <MudSpacer/>
    @if (_initEd)
    {
        <MudTable Items="@ItemDeltaShouldShow" Dense="@true" Hover="@true" Bordered="@true">
            <ToolBarContent>
                <MudContainer Style="display: flex; align-items: center; height: 100%;">
                    <MudText Typo="Typo.h6">@("item::change::list".Translate(I18NMgr.I18N!))</MudText>
                    <MudSwitch @bind-Value="_showAdd" Color="Color.Success">@("add".Translate(I18NMgr.I18N!))</MudSwitch>
                    <MudSwitch @bind-Value="_showChange" Color="Color.Warning">@("change".Translate(I18NMgr.I18N!))</MudSwitch>
                    <MudSwitch @bind-Value="_showRemove" Color="Color.Error">@("remove".Translate(I18NMgr.I18N!))</MudSwitch>
                </MudContainer>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>@(string.Join(I18NMgr.I18N!.LinkTag, "item".Translate(I18NMgr.I18N!), "ID"))</MudTh>
                <MudTh>@("item::name".Translate(I18NMgr.I18N!))</MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<KeyValuePair<MongoId, double>, object>(x => x.Value)">
                        @("item::change".Translate(I18NMgr.I18N!))
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortBy="new Func<KeyValuePair<MongoId, double>, object>(x => GetPrice(x))">
                        @("webUI.value::change".Translate(I18NMgr.I18N!))
                    </MudTableSortLabel>
                </MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Key</MudTd>
                <MudTd>@I18NMgr.GetItemName(context.Key)</MudTd>
                <MudTd>
                    <MudText Color="@GetColor(context.Key)">@context.Value</MudText>
                </MudTd>
                <MudTd>
                    <MudText Color="@GetColor(context.Key)">@GetPrice(context)</MudText>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager/>
            </PagerContent>
        </MudTable>
    }
    else
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7"/>
    }
</MudPaper>

@code {
    /// <summary> 存档 </summary>
    [Parameter] public required RaidArchive Archive { get; set; }
    /// <summary> 初始化的异步延迟 用来避免其他控件卡住 </summary>
    [Parameter] public int InitDelay { get; set; } = 200;

    private readonly Dictionary<MongoId, double> _itemDeltaCache = [];

    private Dictionary<MongoId, double> ItemDeltaShouldShow => _itemDeltaCache.Where(ShouldShow).ToDictionary();

    private bool _initEd;

    private bool _showAdd = true;
    private bool _showChange = true;
    private bool _showRemove = true;
    private readonly List<MongoId> _add = [];
    private readonly List<MongoId> _remove = [];
    private readonly List<MongoId> _change = [];
    private readonly HashSet<MongoId> _addSet = [];
    private readonly HashSet<MongoId> _removeSet = [];

    private double GetPrice(KeyValuePair<MongoId, double> item) => PriceSystem.GetItemValueWithCache(item.Key) * item.Value;

    private Color GetColor(MongoId id)
    {
        if (_addSet.Contains(id)) return Color.Success;
        return _removeSet.Contains(id) ? Color.Error : Color.Warning;
    }

    private bool ShouldShow(KeyValuePair<MongoId, double> item)
    {
        MongoId id = item.Key;
        if (Math.Abs(item.Value) < Constants.Epsilon) return false;
        if (_addSet.Contains(id) && _showAdd) return true;
        if (_removeSet.Contains(id) && _showRemove) return true;
        if (_change.Contains(id) && _showChange) return true;
        return false;
    }

    protected override async Task OnInitializedAsync()
    {
        if (!_initEd)
        {
            await Task.Delay(InitDelay);
            _initEd = true;
        }
        RaidUtil.UpdateItemsChanged(_add, _remove, _change, Archive.ItemsTakeIn, Archive.ItemsTakeOut);
        _addSet.UnionWith(_add);
        _removeSet.UnionWith(_remove);
        foreach (MongoId tpl in Archive.ItemsTakeIn.Keys.Union(Archive.ItemsTakeOut.Keys))
        {
            _itemDeltaCache[tpl] =
                Archive.ItemsTakeOut.GetValueOrDefault(tpl, 0) -
                Archive.ItemsTakeIn.GetValueOrDefault(tpl, 0);
        }
        await base.OnInitializedAsync();
    }

}