@page "/RaidRecord/Setting"

@inject I18N I18N
@inject ISnackbar Snackbar
@inject ModConfig ModConfig
@inject WebDataContext WebData
@inject NavigationManager Navigation

<MainLayout/>

<MudPaper>
    <MudText Typo="Typo.h4">@I18N.WebUILocal.SettingTitle</MudText>
    <MudSelect @bind-Value="Local"
               Style="width: auto"
               Label="@I18N.WebUILocal.SelectLang"
               AdornmentColor="Color.Secondary">
        @foreach (string lang in I18N.AvailableLang)
        {
            <MudSelectItem Value="@lang">@lang</MudSelectItem>
        }
    </MudSelect>
    <MudSwitch @bind-Value="AutoUnloadOtherLang" Label="@I18N.WebUILocal.AutoUnloadLang" Color="Color.Secondary"/>
    <MudNumericField @bind-Value="PriceCacheUpdateMinTime" Label="@I18N.WebUILocal.PriceCacheUpdateMinTime" Variant="Variant.Text" Min="1" Max="604800000"/>

    <MudButton OnClick="@(() => OnSaveConfig())">@I18N.WebUILocal.SaveConfigChange</MudButton>
    <MudButton OnClick="@(() => CancelSaveConfig())">@I18N.WebUILocal.CancelConfigChange</MudButton>
</MudPaper>

@code {
    string? _local;

    public string? Local
    {
        get => _local;
        set
        {
            if (string.IsNullOrEmpty(value)
                || !I18N.AvailableLang.Contains(value)
                || I18N.CurrLang == value) return;
            _local = value;
        }
    }

    public bool AutoUnloadOtherLang { get; set; }

    public long PriceCacheUpdateMinTime { get; set; }

    private void OnSaveConfig()
    {
        if (!string.IsNullOrEmpty(_local) && _local.Length == 2)
        {
            ModConfig.Configs.Local = _local;
            Task.Run(() => { I18N.CurrLang = _local; });
        }
        ModConfig.Configs.AutoUnloadOtherLang = AutoUnloadOtherLang;
        ModConfig.Configs.PriceCacheUpdateMinTime = PriceCacheUpdateMinTime;
        _ = ModConfig.SaveConfig();
        Snackbar.Add(I18N.DumpFormatStrLocal(I18N.WebUILocal.SaveConfigSuccess, new { CurrLang = _local }));
    }

    private void CancelSaveConfig()
    {
        _local = ModConfig.Configs.Local;
        AutoUnloadOtherLang = ModConfig.Configs.AutoUnloadOtherLang;
        PriceCacheUpdateMinTime = ModConfig.Configs.PriceCacheUpdateMinTime;
    }

    protected override void OnInitialized()
    {
        _local = ModConfig.Configs.Local;
        AutoUnloadOtherLang = ModConfig.Configs.AutoUnloadOtherLang;
        PriceCacheUpdateMinTime = ModConfig.Configs.PriceCacheUpdateMinTime;
        base.OnInitialized();
        if (string.IsNullOrEmpty(WebData.CurrAccount))
        {
            Navigation.NavigateTo("/RaidRecord", true);
        }
    }
}