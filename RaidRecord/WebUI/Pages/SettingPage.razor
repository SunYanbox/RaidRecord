@page "/RaidRecord/Setting"

@inject I18N I18N
@inject ISnackbar Snackbar
@inject ModConfig ModConfig
@inject WebDataContext WebData
@inject DataGetterService DataGetter
@inject NavigationManager Navigation

<MainLayout/>

<MudPaper>
    <MudText Typo="Typo.h4">@I18N.WebUILocal.SettingTitle</MudText>
    <MudStack>
        @* 本地化语言 *@
        <MudSelect @bind-Value="Local"
                   Style="width: auto"
                   Label="@I18N.WebUILocal.SelectLang"
                   AdornmentColor="Color.Secondary">
            @foreach (string lang in I18N.AvailableLang)
            {
                <MudSelectItem Value="@lang">@lang</MudSelectItem>
            }
        </MudSelect>
        @* 自动卸载其他语言 *@
        <MudTooltip Text="@I18N.WebUILocal.AutoUnloadLangDesc">
            <MudSwitch @bind-Value="AutoUnloadOtherLang" Label="@I18N.WebUILocal.AutoUnloadLang" Color="Color.Secondary"/>
        </MudTooltip>
        @* 价格缓存更新时间 *@
        <MudNumericField @bind-Value="PriceCacheUpdateMinTime" Label="@I18N.WebUILocal.PriceCacheUpdateMinTime" Variant="Variant.Text" Min="1" Max="604800000"/>
        @* 模组 Give 是否为 FIR *@
        <MudTooltip Text="@I18N.WebUILocal.ModGiveIsFIRDesc">
            <MudSwitch @bind-Value="ModGiveIsFIR" Label="@I18N.WebUILocal.ModGiveIsFIR" Color="Color.Info"/>
        </MudTooltip>
        @* 深色模式 *@
        <MudSwitch @bind-Value="DarkMode" Label="@I18N.WebUILocal.IsDarkMode" Color="Color.Info"/>
        @* 维修耐久度 *@
        <MudTooltip Text="@I18N.WebUILocal.IsRepairDurabilityDesc">
            <MudSwitch @bind-Value="IsRepairDurability" Label="@I18N.WebUILocal.IsRepairDurability" Color="Color.Info"/>
        </MudTooltip>
    </MudStack>
    
    <MudStack Row="true">
        <MudButton OnClick="@(() => OnSaveConfig())">@I18N.WebUILocal.SaveConfigChange</MudButton>
        <MudButton OnClick="@(() => CancelSaveConfig())">@I18N.WebUILocal.CancelConfigChange</MudButton>
        <MudTooltip Text="@I18N.WebUILocal.ReInitLangDesc">
            <MudButton OnClick="@(() => { I18N.ReInitLang(); DataGetter.ReInitName2Id(); })">@I18N.WebUILocal.ReInitLang</MudButton>
        </MudTooltip>
    </MudStack>
</MudPaper>

@code {
    string? _local;

    protected string? Local
    {
        get => _local;
        set
        {
            if (string.IsNullOrEmpty(value)
                || !I18N.AvailableLang.Contains(value)
                || I18N.CurrLang == value) return;
            _local = value;
        }
    }

    protected bool AutoUnloadOtherLang { get; set; }

    protected long PriceCacheUpdateMinTime { get; set; }

    protected bool ModGiveIsFIR { get; set; }
    
    protected bool DarkMode { get; set; }
    
    protected bool IsRepairDurability { get; set; }
    
    private void OnSaveConfig()
    {
        if (!string.IsNullOrEmpty(_local) && _local.Length == 2)
        {
            ModConfig.Configs.Local = _local;
            Task.Run(() => {
                I18N.CurrLang = _local;
                DataGetter.ReInitName2Id();
            });
        }
        ModConfig.Configs.AutoUnloadOtherLang = AutoUnloadOtherLang;
        ModConfig.Configs.PriceCacheUpdateMinTime = PriceCacheUpdateMinTime;
        ModConfig.Configs.ModGiveIsFIR = ModGiveIsFIR;
        ModConfig.Configs.DarkMode = DarkMode;
        ModConfig.Configs.IsRepairDurability = IsRepairDurability;
        _ = ModConfig.SaveConfig();
        Snackbar.Add(I18N.DumpFormatStrLocal(I18N.WebUILocal.SaveConfigSuccess, new { CurrLang = _local }));
    }

    private void CancelSaveConfig()
    {
        _local = ModConfig.Configs.Local;
        AutoUnloadOtherLang = ModConfig.Configs.AutoUnloadOtherLang;
        PriceCacheUpdateMinTime = ModConfig.Configs.PriceCacheUpdateMinTime;
        ModGiveIsFIR = ModConfig.Configs.ModGiveIsFIR;
        DarkMode = ModConfig.Configs.DarkMode;
        IsRepairDurability = ModConfig.Configs.IsRepairDurability;
    }

    protected override void OnInitialized()
    {
        _local = ModConfig.Configs.Local;
        AutoUnloadOtherLang = ModConfig.Configs.AutoUnloadOtherLang;
        PriceCacheUpdateMinTime = ModConfig.Configs.PriceCacheUpdateMinTime;
        ModGiveIsFIR = ModConfig.Configs.ModGiveIsFIR;
        DarkMode = ModConfig.Configs.DarkMode;
        IsRepairDurability = ModConfig.Configs.IsRepairDurability;
        base.OnInitialized();
        if (string.IsNullOrEmpty(WebData.CurrAccount))
        {
            Navigation.NavigateTo("/RaidRecord", true);
        }
    }
}