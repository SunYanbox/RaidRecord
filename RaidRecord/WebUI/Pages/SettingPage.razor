@page "/RaidRecord/Setting"
@using System.Diagnostics
@using SPTarkov.Server.Core.Models.Common
@using Color = MudBlazor.Color

@inject I18NMgr I18NMgr
@inject RaidUtil RaidUtil
@inject ISnackbar Snackbar
@inject ModConfig ModConfig
@inject WebDataContext WebData
@inject RecordManager RecordManager
@inject DataGetterService DataGetter
@inject NavigationManager Navigation

<MainLayout/>

<MudPaper>
    <MudText Typo="Typo.h4">@I18NMgr.WebUILocal.SettingTitle</MudText>
    <MudStack>
        @* 本地化语言 *@
        <MudSelect @bind-Value="Local"
                   Style="width: auto"
                   Label="@I18NMgr.WebUILocal.SelectLang"
                   AdornmentColor="Color.Secondary">
            @foreach (string lang in I18NMgr.I18N!.AvailableLang)
            {
                <MudSelectItem Value="@lang">@lang</MudSelectItem>
            }
        </MudSelect>
        @* 自动卸载其他语言 *@
        <MudTooltip Text="@I18NMgr.WebUILocal.AutoUnloadLangDesc">
            <MudSwitch @bind-Value="AutoUnloadOtherLang" Label="@I18NMgr.WebUILocal.AutoUnloadLang" Color="Color.Secondary"/>
        </MudTooltip>
        @* 价格缓存更新时间 *@
        <MudNumericField @bind-Value="PriceCacheUpdateMinTime" Label="@I18NMgr.WebUILocal.PriceCacheUpdateMinTime" Variant="Variant.Text" Min="1" Max="604800000"/>
        @* 模组 Give 是否为 FIR *@
        <MudTooltip Text="@I18NMgr.WebUILocal.ModGiveIsFIRDesc">
            <MudSwitch @bind-Value="ModGiveIsFIR" Label="@I18NMgr.WebUILocal.ModGiveIsFIR" Color="Color.Info"/>
        </MudTooltip>
        @* 深色模式 *@
        <MudSwitch @bind-Value="DarkMode" Label="@I18NMgr.WebUILocal.IsDarkMode" Color="Color.Info"/>
        @* 维修耐久度 *@
        <MudTooltip Text="@I18NMgr.WebUILocal.IsRepairDurabilityDesc">
            <MudSwitch @bind-Value="IsRepairDurability" Label="@I18NMgr.WebUILocal.IsRepairDurability" Color="Color.Info"/>
        </MudTooltip>
    </MudStack>
    
    @* 修复面板 *@
    <MudPaper Outlined="true">
        <MudText>修复面板</MudText>
        @* 修复当前存档所有对局战损与收益计算 *@
        <MudButton OnClick="@(async () => await FixAllArchive())">
            @I18NMgr.WebUILocal.FixAllArchiveCombatLoss
        </MudButton>
    </MudPaper>
    
    @* 理赔 *@
    <ClaimCompensationWidget />
    
    <MudStack Row="true">
        <MudButton OnClick="@(() => OnSaveConfig())">@I18NMgr.WebUILocal.SaveConfigChange</MudButton>
        <MudButton OnClick="@(() => CancelSaveConfig())">@I18NMgr.WebUILocal.CancelConfigChange</MudButton>
        <MudTooltip Text="@I18NMgr.WebUILocal.ReInitLangDesc">
            <MudButton OnClick="@(() => { I18NMgr.ReInitLang(); DataGetter.ReInitName2Id(); })">@I18NMgr.WebUILocal.ReInitLang</MudButton>
        </MudTooltip>
        <MudTooltip Text="@I18NMgr.WebUILocal.CheckUpdateDesc">
            <MudButton OnClick="@(() => CheckUpdate())">@I18NMgr.WebUILocal.CheckUpdate</MudButton>
        </MudTooltip>
    </MudStack>
</MudPaper>

@code {
    string? _local;

    protected string? Local
    {
        get => _local;
        set
        {
            if (string.IsNullOrEmpty(value)
                || !I18NMgr.I18N!.AvailableLang.Contains(value)
                || I18NMgr.CurrLang == value) return;
            _local = value;
        }
    }

    protected bool AutoUnloadOtherLang { get; set; }

    protected long PriceCacheUpdateMinTime { get; set; }

    protected bool ModGiveIsFIR { get; set; }
    
    protected bool DarkMode { get; set; }
    
    protected bool IsRepairDurability { get; set; }
    
    private void OnSaveConfig()
    {
        if (!string.IsNullOrEmpty(_local) && _local.Length == 2)
        {
            ModConfig.Configs.Local = _local;
            Task.Run(() => {
                I18NMgr.CurrLang = _local;
                DataGetter.ReInitName2Id();
            });
        }
        ModConfig.Configs.AutoUnloadOtherLang = AutoUnloadOtherLang;
        ModConfig.Configs.PriceCacheUpdateMinTime = PriceCacheUpdateMinTime;
        ModConfig.Configs.ModGiveIsFIR = ModGiveIsFIR;
        ModConfig.Configs.DarkMode = DarkMode;
        ModConfig.Configs.IsRepairDurability = IsRepairDurability;
        _ = ModConfig.SaveConfig();
        Snackbar.Add(I18NMgr.DumpFormatStrLocal(I18NMgr.WebUILocal.SaveConfigSuccess, new { CurrLang = _local }));
    }

    private void CancelSaveConfig()
    {
        _local = ModConfig.Configs.Local;
        AutoUnloadOtherLang = ModConfig.Configs.AutoUnloadOtherLang;
        PriceCacheUpdateMinTime = ModConfig.Configs.PriceCacheUpdateMinTime;
        ModGiveIsFIR = ModConfig.Configs.ModGiveIsFIR;
        DarkMode = ModConfig.Configs.DarkMode;
        IsRepairDurability = ModConfig.Configs.IsRepairDurability;
    }

    protected override void OnInitialized()
    {
        _local = ModConfig.Configs.Local;
        AutoUnloadOtherLang = ModConfig.Configs.AutoUnloadOtherLang;
        PriceCacheUpdateMinTime = ModConfig.Configs.PriceCacheUpdateMinTime;
        ModGiveIsFIR = ModConfig.Configs.ModGiveIsFIR;
        DarkMode = ModConfig.Configs.DarkMode;
        IsRepairDurability = ModConfig.Configs.IsRepairDurability;
        base.OnInitialized();
        if (string.IsNullOrEmpty(WebData.CurrAccount))
        {
            Navigation.NavigateTo("/RaidRecord", true);
        }
    }
    
    /// <summary>
    /// 修复当前账号的所有存档的收益, 战损计算结果
    /// </summary>
    protected async Task FixAllArchive()
    {
        MongoId account = WebData.CurrAccount;
        EFTCombatRecord profile = await RecordManager.GetRecord(account);
        var result = string.Empty;
        foreach (RaidDataWrapper wrapper in profile.Records)
        {
            if (wrapper.Archive is null) continue;
            (long grossProfitDelta, long combatLossesDelta) = RaidUtil.ReCalculateArchive(wrapper.Archive);
            if (!(Math.Abs(grossProfitDelta) > Constants.Epsilon) && !(Math.Abs(combatLossesDelta) > Constants.Epsilon)) continue;
            result += $"{wrapper.Archive.ServerId} {I18NMgr.WebUILocal.GrossProfit}: {grossProfitDelta:+0.00;-0.00;0.00}  {I18NMgr.WebUILocal.GrossProfit}: {combatLossesDelta:+0.00;-0.00;0.00}\n";
        }
        await RecordManager.SaveEFTRecord(account);
        Snackbar.Add(I18NMgr.WebUILocal.Link(
            I18NMgr.WebUILocal.FixAllArchiveCompleted,
            ": ",
            result));
    }

    protected void CheckUpdate()
    {
        const string url = "https://forge.sp-tarkov.com/mod/2341/raidrecord#versions";

        try
        {
            try
            {
                Process.Start(new ProcessStartInfo
                {
                    FileName = url,
                    UseShellExecute = true
                });
            }
            catch (Exception ex)
            {
                ModConfig.Error($"无法打开浏览器：{ex.Message}");
            }
        }
        catch (Exception ex)
        {
            ModConfig.Error($"无法打开URL: {ex.Message}");
        }
    }
}