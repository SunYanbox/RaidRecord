@page "/RaidRecord/Setting"
@using System.Diagnostics
@using SPTarkov.Server.Core.Models.Common
@using Color = MudBlazor.Color

@inject I18NMgr I18NMgr
@inject RaidUtil RaidUtil
@inject ISnackbar Snackbar
@inject ModConfig ModConfig
@inject WebDataContext WebData
@inject RecordManager RecordManager
@inject DataGetterService DataGetter
@inject NavigationManager Navigation

<MainLayout/>

<MudPaper>
    <MudText Typo="Typo.h4">@("webUI.settingTitle".Translate(I18NMgr.I18N!))</MudText>
    <MudStack>
        @* 本地化语言 *@
        <MudSelect @bind-Value="Local"
                   Style="width: auto"
                   Label="@("webUI.selectLang".Translate(I18NMgr.I18N!))"
                   AdornmentColor="Color.Secondary">
            @foreach (string lang in I18NMgr.I18N!.AvailableLang)
            {
                <MudSelectItem Value="@lang">@lang</MudSelectItem>
            }
        </MudSelect>
        @* 自动卸载其他语言 *@
        <MudTooltip Text="@("webUI.autoUnloadOtherLangDesc".Translate(I18NMgr.I18N!))">
            <MudSwitch @bind-Value="AutoUnloadOtherLang" Label="@("webUI.autoUnloadOtherLang".Translate(I18NMgr.I18N!))" Color="Color.Secondary"/>
        </MudTooltip>
        @* 价格缓存更新时间 *@
        <MudNumericField @bind-Value="PriceCacheUpdateMinTime" Label="@("webUI.priceCacheUpdateMinTime".Translate(I18NMgr.I18N!))" Variant="Variant.Text" Min="1" Max="604800000"/>
        @* 模组 Give 是否为 FIR *@
        <MudTooltip Text="@("webUI.modGiveIsFIRDesc".Translate(I18NMgr.I18N!))">
            <MudSwitch @bind-Value="ModGiveIsFIR" Label="@("webUI.modGiveIsFIR".Translate(I18NMgr.I18N!))" Color="Color.Info"/>
        </MudTooltip>
        @* 深色模式 *@
        <MudSwitch @bind-Value="DarkMode" Label="@("webUI.isDarkMode".Translate(I18NMgr.I18N!))" Color="Color.Info"/>
        @* 维修耐久度 *@
        <MudTooltip Text="@("webUI.isRepairDurabilityDesc".Translate(I18NMgr.I18N!))">
            <MudSwitch @bind-Value="IsRepairDurability" Label="@("webUI.isRepairDurability".Translate(I18NMgr.I18N!))" Color="Color.Info"/>
        </MudTooltip>
    </MudStack>
    
    @* 修复面板 *@
    <MudPaper Outlined="true">
        <MudText>修复面板</MudText>
        @* 修复当前存档所有对局战损与收益计算 *@
        <MudButton OnClick="@(async () => await FixAllArchive())">
            @("webUI.fixAllArchiveCompleted".Translate(I18NMgr.I18N!))
        </MudButton>
    </MudPaper>
    
    @* 理赔 *@
    <ClaimCompensationWidget />
    
    <MudStack Row="true">
        <MudButton OnClick="@(() => OnSaveConfig())">@("webUI.saveConfigChange".Translate(I18NMgr.I18N!))</MudButton>
        <MudButton OnClick="@(() => CancelSaveConfig())">@("webUI.cancelConfigChange".Translate(I18NMgr.I18N!))</MudButton>
        <MudTooltip Text="@("webUI.reInitLangDesc".Translate(I18NMgr.I18N!))">
            <MudButton OnClick="@(() => { I18NMgr.ReInitLang(); DataGetter.ReInitName2Id(); })">@("webUI.reInitLang".Translate(I18NMgr.I18N!))</MudButton>
        </MudTooltip>
        <MudTooltip Text="@("webUI.checkUpdateDesc".Translate(I18NMgr.I18N!))">
            <MudButton OnClick="@(() => CheckUpdate())">@("webUI.checkUpdate".Translate(I18NMgr.I18N!))</MudButton>
        </MudTooltip>
    </MudStack>
</MudPaper>

@code {
    string? _local;

    protected string? Local
    {
        get => _local;
        set
        {
            if (string.IsNullOrEmpty(value)
                || !I18NMgr.I18N!.AvailableLang.Contains(value)
                || I18NMgr.I18N.CurrentLang == value) return;
            _local = value;
        }
    }

    protected bool AutoUnloadOtherLang { get; set; }

    protected long PriceCacheUpdateMinTime { get; set; }

    protected bool ModGiveIsFIR { get; set; }
    
    protected bool DarkMode { get; set; }
    
    protected bool IsRepairDurability { get; set; }
    
    private void OnSaveConfig()
    {
        if (!string.IsNullOrEmpty(_local) && _local.Length == 2)
        {
            ModConfig.Configs.Local = _local;
            Task.Run(() => {
                I18NMgr.I18N!.CurrentLang = _local;
                DataGetter.ReInitName2Id();
            });
        }
        ModConfig.Configs.AutoUnloadOtherLang = AutoUnloadOtherLang;
        ModConfig.Configs.PriceCacheUpdateMinTime = PriceCacheUpdateMinTime;
        ModConfig.Configs.ModGiveIsFIR = ModGiveIsFIR;
        ModConfig.Configs.DarkMode = DarkMode;
        ModConfig.Configs.IsRepairDurability = IsRepairDurability;
        _ = ModConfig.SaveConfig();
        Snackbar.Add("webUI.saveConfigSuccess".Translate(I18NMgr.I18N!, new { CurrLang = _local }));
    }

    private void CancelSaveConfig()
    {
        _local = ModConfig.Configs.Local;
        AutoUnloadOtherLang = ModConfig.Configs.AutoUnloadOtherLang;
        PriceCacheUpdateMinTime = ModConfig.Configs.PriceCacheUpdateMinTime;
        ModGiveIsFIR = ModConfig.Configs.ModGiveIsFIR;
        DarkMode = ModConfig.Configs.DarkMode;
        IsRepairDurability = ModConfig.Configs.IsRepairDurability;
    }

    protected override void OnInitialized()
    {
        _local = ModConfig.Configs.Local;
        AutoUnloadOtherLang = ModConfig.Configs.AutoUnloadOtherLang;
        PriceCacheUpdateMinTime = ModConfig.Configs.PriceCacheUpdateMinTime;
        ModGiveIsFIR = ModConfig.Configs.ModGiveIsFIR;
        DarkMode = ModConfig.Configs.DarkMode;
        IsRepairDurability = ModConfig.Configs.IsRepairDurability;
        base.OnInitialized();
        if (string.IsNullOrEmpty(WebData.CurrAccount))
        {
            Navigation.NavigateTo("/RaidRecord", true);
        }
    }
    
    /// <summary>
    /// 修复当前账号的所有存档的收益, 战损计算结果
    /// </summary>
    protected async Task FixAllArchive()
    {
        MongoId account = WebData.CurrAccount;
        EFTCombatRecord profile = await RecordManager.GetRecord(account);
        var result = string.Empty;
        foreach (RaidDataWrapper wrapper in profile.Records)
        {
            if (wrapper.Archive is null) continue;
            (long grossProfitDelta, long combatLossesDelta) = RaidUtil.ReCalculateArchive(wrapper.Archive);
            if (!(Math.Abs(grossProfitDelta) > Constants.Epsilon) && !(Math.Abs(combatLossesDelta) > Constants.Epsilon)) continue;
            result += $"{wrapper.Archive.ServerId} {"grossProfit".Translate(I18NMgr.I18N!)}: {grossProfitDelta:+0.00;-0.00;0.00}  {"combatLoss".Translate(I18NMgr.I18N!)}: {combatLossesDelta:+0.00;-0.00;0.00}\n";
        }
        await RecordManager.SaveEFTRecord(account);
        Snackbar.Add(string.Join(I18NMgr.I18N!.LinkTag, "webUI.fixAllArchiveCompleted".Translate(I18NMgr.I18N!), ": ", result));
    }

    protected void CheckUpdate()
    {
        const string url = "https://forge.sp-tarkov.com/mod/2341/raidrecord#versions";

        try
        {
            try
            {
                Process.Start(new ProcessStartInfo
                {
                    FileName = url,
                    UseShellExecute = true
                });
            }
            catch (Exception ex)
            {
                ModConfig.Error($"无法打开浏览器：{ex.Message}");
            }
        }
        catch (Exception ex)
        {
            ModConfig.Error($"无法打开URL: {ex.Message}");
        }
    }
}