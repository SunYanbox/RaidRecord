@page "/RaidRecord/List"

@inject I18N I18N;
@inject ISnackbar Snackbar
@inject ModConfig ModConfig;
@inject WebDataContext WebData;
@inject RecordManager RecordManager;
@inject DataFormatService DataFormat;
@inject DataGetterService DataGetter;
@inject NavigationManager Navigation;

<MainLayout/>

<MudTable Items="@RaidArchiveIndexedAll" FixedHeader="@true" FixedFooter="@true"
          Dense="@true" Hover="@true" ReadOnly="@true" Style="width: 100%;"
          @bind-SelectedItem="SelectedArchiveIndexed" SortLabel="Sort By">
    <ToolBarContent>
        <MudIcon Icon="@Icons.Material.Filled.History" Color="Color.Success"/>
        <MudText Typo="Typo.h6" Style="text-indent: 2ch;">@I18N.WebUILocal.ListTitle</MudText>
        <MudSwitch Label="@I18N.WebUILocal.WillClickOpenJump" @bind-Value="_jump2DetailPage" Color="Color.Success"/>
    </ToolBarContent>
    <ColGroup>
        <col style="min-width: 8ch"/>
        <col style="min-width: 8ch"/>
        <col style="min-width: 10ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 8ch"/>
        <col style="min-width: 16ch"/>
        <col style="min-width: 16ch"/>
    </ColGroup>
    <HeaderContent>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Index)">
                Index
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            @I18N.WebUILocal.Side
        </MudTh>
        <MudTh>
            @I18N.WebUILocal.Map
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Archive.CreateTime)">
                @I18N.WebUILocal.CreateTime
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Archive.PreRaidValue)">
                @(I18N.WebUILocal.PreRaidValue)(rub)
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Archive.EquipmentValue)">
                @(I18N.WebUILocal.EquipmentValue)(rub)
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Archive.GrossProfit)">
                @(I18N.WebUILocal.GrossProfit)(rub)
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Archive.CombatLosses)">
                @(I18N.WebUILocal.CombatLoss)(rub)
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => DataFormat.GetNetProfit(x.Archive))">
                @(I18N.WebUILocal.NetProfit)(rub)
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => DataFormat.GetKillCount(x.Archive))">
                @I18N.WebUILocal.KillCount
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            @I18N.WebUILocal.Result
        </MudTh>
        <MudTh>
            @I18N.WebUILocal.ToolBar
        </MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context!.Index</MudTd>
        <MudTd>@context!.Archive.Side</MudTd>
        <MudTd>@DataFormat.GetMapNameLocal(context!.Archive)</MudTd>
        <MudTd>@DataFormat.FromDateTimeSeconds(context!.Archive.CreateTime)</MudTd>
        <MudTd>@context!.Archive.PreRaidValue</MudTd>
        <MudTd>@context!.Archive.EquipmentValue</MudTd>
        <MudTd>@context!.Archive.GrossProfit</MudTd>
        <MudTd>@context!.Archive.CombatLosses</MudTd>
        <MudTd>@DataFormat.GetNetProfit(context!.Archive)</MudTd>
        <MudTd>@DataFormat.GetKillCount(context!.Archive)</MudTd>
        <MudTd>@DataFormat.GetResultStr(context!.Archive)</MudTd>
        <MudTd Style="display: flex; align-content: center">
            <MudMenu Label="@I18N.WebUILocal.ToolMenu" Modal="false">
                <MudMenuItem Label="@I18N.WebUILocal.Info" OnClick="@(() => LookDetails(context!))"/>
                <MudMenuItem Label="@I18N.WebUILocal.QuickEquip" OnClick="@(() => LookQuickEquip(context!))"/>
                <MudMenuItem Label="@I18N.WebUILocal.Link(I18N.WebUILocal.Delete, I18N.WebUILocal.Profile)" Style="color: red" OnClick="@(() => DeleteArchive(context!))"/>
            </MudMenu>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager RowsPerPageString="@I18N.WebUILocal.TablePagerRowsPerPageString" InfoFormat="@I18N.WebUILocal.TablePagerInfoFormat"
                       PageSizeOptions="new[] { 10, 1, 5, 20, 50, 100 }"/>
    </PagerContent>
</MudTable>

<MudOverlay @bind-Visible="_visible" DarkBackground="true" AutoClose="true">
    @switch (_overlayState)
    {
        case OverlayState.QuickEquip:
            <MudContainer @onclick:stopPropagation="true">
                <MudText Typo="Typo.h5">@I18N.WebUILocal.QuickEquip</MudText>
                <MudText Typo="Typo.inherit">@I18N.WebUILocal.ClickOtherZoneToClose</MudText>
                @if (ArchiveContext is null)
                {
                    <MudText>@I18N.WebUILocal.ChoiceArchiveNotExist</MudText>
                }
                else
                {
                    <QuickEquipmentWidget Archive="ArchiveContext" ProvideQuickBuy="@true"/>
                }
            </MudContainer>
            break;
        case OverlayState.DeleteArchive:
            <MudContainer @onclick:stopPropagation="true" Class="overflow-y: auto">
                <MudText Typo="Typo.h5">@($"{I18N.WebUILocal.Link(I18N.WebUILocal.Delete, I18N.WebUILocal.Profile)}: {ArchiveContext?.ServerId}?")</MudText>
                <MudText Typo="Typo.inherit">@I18N.WebUILocal.ClickOtherZoneToClose</MudText>
                @if (ArchiveContext is null)
                {
                    <MudText>@I18N.WebUILocal.ChoiceArchiveNotExist</MudText>
                }
                else
                {
                    <ArchiveInfoPaperWidget Archive="ArchiveContext" ShowToolZone="@false"/>
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudButton Color="Color.Error" OnClick="@(async () => await EnsureDelete())">@($"{I18N.WebUILocal.Link(I18N.WebUILocal.Confirm, I18N.WebUILocal.Delete)}?")</MudButton>
                        <MudButton OnClick="@(() => CancelDelete())">@I18N.WebUILocal.Cancel</MudButton>
                    </MudStack>
                }
            </MudContainer>
            break;
        default:
            throw new Exception("ArgumentOutOfRangeException(如果没有随意修改状态机的值, 该错误理论上不会触发)");
    }
    
    @code
    {
        /// <summary>
        /// 快速起装 / 删除存档的上下文
        /// </summary>
        private RaidArchive? ArchiveContext { get; set; }
        
        /// <summary>
        /// 确认删除存档
        /// </summary>
        private async Task EnsureDelete()
        {
            if (ArchiveContext is null) return;
            try
            {
                using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(5)); // 设置 5 秒超时
                
                Task task = Task.Run(async () => 
                {
                    string serverId = ArchiveContext.ServerId;
                    await RecordManager.DeleteRecord(WebData.CurrAccount, serverId).ConfigureAwait(false);
                    WebData.LookingServerIds.RemoveWhere(x => x.Archive.ServerId == serverId);
                    Snackbar.Add($"历史战绩{serverId}已删除");
                }, cts.Token);

                await task.WaitAsync(cts.Token); // 等待任务完成，如果超时这里会抛 OperationCanceledException
            }
            catch (Exception e)
            {
                ModConfig.Error($"删除历史记录过程中出错: {e.Message}", e);
            }
            ToggleOverlay(false);
        }

        /// <summary>
        /// 取消删除存档
        /// </summary>
        private void CancelDelete()
        {
            ToggleOverlay(false);
            _overlayState = OverlayState.QuickEquip;
        }
    }

</MudOverlay>

@code {
    private bool _visible;
    private bool _jump2DetailPage;
    private OverlayState _overlayState = OverlayState.QuickEquip;

    /// <summary>
    /// 弹出窗口的状态
    /// </summary>
    private enum OverlayState
    {
        QuickEquip,
        DeleteArchive
    }
    
    /// <summary>
    /// 显示/隐藏 overlay
    /// </summary>
    public void ToggleOverlay(bool value)
    {
        _visible = value;
    }
    
    public ArchiveIndexed? SelectedArchiveIndexed { get; set; }
    public List<ArchiveIndexed> RaidArchiveIndexedAll => GetArchiveIndexedAll();

    private List<ArchiveIndexed> GetArchiveIndexedAll()
    {
        try
        {
            List<ArchiveIndexed> archivesIndexed = DataGetter.GetArchivesIndexed(WebData.CurrAccount);
            archivesIndexed.Reverse();
            return archivesIndexed;
        }
        catch (Exception e)
        {
            ModConfig.Warn($"获取战绩索引列表时出现错误: {e.Message}");
            return [];
        }
    }

    /// <summary>
    /// 查看战绩详情
    /// </summary>
    public void LookDetails(ArchiveIndexed archiveIndexed)
    {
        try
        {
            if (WebData.LookingServerIds.Add(archiveIndexed))
            {
                Snackbar.Add(I18N.DumpFormatStrLocal(I18N.WebUILocal.AddInfoTabSuccess, new { archiveIndexed.Index, archiveIndexed.Archive.ServerId }));
                if (_jump2DetailPage) Navigation.NavigateTo("/RaidRecord/Info", true);
            }
            else
            {
                Snackbar.Add(I18N.DumpFormatStrLocal(I18N.WebUILocal.AddInfoTabFail, new { archiveIndexed.Index, archiveIndexed.Archive.ServerId }));
            }
        }
        catch (Exception e)
        {
            ModConfig.Warn($"查看战绩详情时出现错误: {e.Message}");
        }
    }
    
    /// <summary>
    /// 查看快速购买界面
    /// </summary>
    public void LookQuickEquip(ArchiveIndexed archiveIndexed)
    {
        try
        {
            ArchiveContext = archiveIndexed.Archive;
            _overlayState = OverlayState.QuickEquip;
            ToggleOverlay(true);
        }
        catch (Exception e)
        {
            ModConfig.Warn($"查看快速购买界面时出现错误: {e.Message}");
        }
    }
    
    /// <summary>
    /// 删除存档
    /// </summary>
    public void DeleteArchive(ArchiveIndexed archiveIndexed)
    {
        try
        {
            ArchiveContext = archiveIndexed.Archive;
            _overlayState = OverlayState.DeleteArchive;
            ToggleOverlay(true);
        }
        catch (Exception e)
        {
            ModConfig.Warn($"查看快速购买界面时出现错误: {e.Message}");
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        if (string.IsNullOrEmpty(WebData.CurrAccount))
        {
            Navigation.NavigateTo("/RaidRecord", true);
        }
    }
}