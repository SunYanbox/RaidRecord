@page "/RaidRecord/List"

@inject I18N I18N;
@inject ModConfig ModConfig;
@inject WebDataContext WebData;
@inject DataGetterService DataGetter;

<MainLayout/>

<MudContainer>
    @{
        ArchivePageableResult? archivePageableResult = GetArchivePageable();
        
        @if (archivePageableResult?.Errors?.Count > 0)
        {
            <MudText>获取数据时出现错误: @string.Join(",", archivePageableResult.Errors)</MudText>
        }
        else if (archivePageableResult?.Archives.Count > 0)
        {
            <MudDataGrid Items="@archivePageableResult.Archives" Filterable="false" SortMode="@SortMode.None" Groupable="false">
                <Columns>
                    <PropertyColumn Property="x => x.Index"/>
                    <PropertyColumn Property="x => x.Archive.Side" Title="阵营"/>
                    <PropertyColumn Property="x => GetArchiveMapName(x.Archive)" Title="地图"/>
                    <PropertyColumn Property="x => FromUnixTimestampSeconds(x.Archive.CreateTime)" Title="创建时间"/>
                    <PropertyColumn Property="x => x.Archive.PreRaidValue" Title="入局带入(rub)"/>
                    <PropertyColumn Property="x => x.Archive.EquipmentValue" Title="战备价值(rub)"/>
                    <PropertyColumn Property="x => x.Archive.GrossProfit" Title="毛收益(rub)"/>
                    <PropertyColumn Property="x => x.Archive.CombatLosses" Title="战损(rub)"/>
                    <PropertyColumn Property="x => x.Archive.GrossProfit - x.Archive.CombatLosses" Title="净利润(rub)"/>
                    <PropertyColumn Property="x => GetKillCount(x.Archive)" Title="击杀数"/>
                    <PropertyColumn Property="x => GetResultString(x.Archive)" Title="结果"/>
                    @* <TemplateColumn CellClass="d-flex justify-end"> *@
                    @*     <CellTemplate> *@
                    @*         <MudStack Row> *@
                    @*             <MudRating Size="@Size.Small" SelectedValue="@context.Item.Rating"/> *@
                    @*             <MudButton Size="@Size.Small" Variant="@Variant.Filled" Color="@Color.Primary">Hire</MudButton> *@
                    @*         </MudStack> *@
                    @*     </CellTemplate> *@
                    @* </TemplateColumn> *@
                </Columns>
            </MudDataGrid>
            // 暂时用滑块设置每页数量
            <MudContainer Style="display: flex">
                <MudSlider @bind-Value="PageLimit" Min="1" Max="50" Color="Color.Info">每页行数: @PageLimit.ToString()</MudSlider>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Style="margin-left: 4px" OnClick="() => { PageLimit = 10; SelectPage = -1; }">重置</MudButton>
            </MudContainer>
            // 分页
            if (archivePageableResult.PageMax > 1)
            {
                <MudPagination Rectangular="true" Variant="Variant.Filled" Count="@archivePageableResult.PageMax" @bind-Selected="SelectPage" Class="my-4"/>
            }
        }
        else
        {
            <MudText>未发现存档信息, 请选择存档或进行任意对局后再来吧</MudText>
            <MudProgressCircular Color="Color.Default" Indeterminate="true"/>
        }
    }
</MudContainer>

@code {
    public int PageLimit { get; set; } = 10;
    public int SelectPage { get; set; } = -1;
    public List<RaidArchive> RaidArchives => DataGetter.GetArchivesBySession(WebData.CurrentAccount);
    public ArchivePageableResult? GetArchivePageable()
    {
        try
        {
            ArchivePageableResult result = DataGetter.GetArchivesPageable(WebData.CurrentAccount, SelectPage, PageLimit);
            SelectPage = result.Page;
            return result;
        }
        catch (Exception e)
        {
            ModConfig.Warn($"获取分页后的战绩时出现错误: {e.Message}");
            return null;
        }
    }
    
    private string FromUnixTimestampSeconds(long seconds)
    {
        DateTime time = DateTimeOffset.FromUnixTimeSeconds(seconds).DateTime;
        return time.ToShortDateString() + " " + time.ToShortTimeString();
    }

    private string GetArchiveMapName(RaidArchive archive)
    {
        return I18N.GetMapName(archive.ServerId[..archive.ServerId.IndexOf('.')].ToLower());
    }
    
    private int GetKillCount(RaidArchive archive)
    {
        return archive.EftStats?.Victims?.Count() ?? 0;
    }
    
    private string GetResultString(RaidArchive archive)
    {
        return archive.Results?.Result.ToString() ?? "未知结局";
    }
}