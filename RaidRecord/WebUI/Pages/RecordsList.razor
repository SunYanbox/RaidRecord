@page "/RaidRecord/List"

@inject I18N I18N;
@inject ISnackbar Snackbar
@inject WebDataContext WebData;
@inject ModConfig ModConfig;
@inject DataFormatService DataFormat;
@inject DataGetterService DataGetter;
@inject NavigationManager Navigation;

<MainLayout/>

<MudTable Items="@RaidArchiveIndexedAll" FixedHeader="@true" FixedFooter="@true"
          Dense="@true" Hover="@true" ReadOnly="@true" Style="width: 100%;"
          @bind-SelectedItem="SelectedArchiveIndexed" SortLabel="Sort By">
    <ToolBarContent>
        <MudIcon Icon="@Icons.Material.Filled.History" Color="Color.Success"/>
        <MudText Typo="Typo.h6" Style="text-indent: 2ch;">@I18N.WebUILocal.ListTitle</MudText>
        <MudSwitch Label="@I18N.WebUILocal.WillClickOpenJump" @bind-Value="_jump2DetailPage" Color="Color.Success"/>
    </ToolBarContent>
    <ColGroup>
        <col style="min-width: 8ch"/>
        <col style="min-width: 8ch"/>
        <col style="min-width: 10ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 17ch"/>
        <col style="min-width: 8ch"/>
        <col style="min-width: 16ch"/>
        <col style="min-width: 16ch"/>
    </ColGroup>
    <HeaderContent>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Index)">
                Index
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            @I18N.WebUILocal.Side
        </MudTh>
        <MudTh>
            @I18N.WebUILocal.Map
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Archive.CreateTime)">
                @I18N.WebUILocal.CreateTime
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Archive.PreRaidValue)">
                @(I18N.WebUILocal.PreRaidValue)(rub)
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Archive.EquipmentValue)">
                @(I18N.WebUILocal.EquipmentValue)(rub)
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Archive.GrossProfit)">
                @(I18N.WebUILocal.GrossProfit)(rub)
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => x.Archive.CombatLosses)">
                @(I18N.WebUILocal.CombatLoss)(rub)
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => DataFormat.GetNetProfit(x.Archive))">
                @(I18N.WebUILocal.NetProfit)(rub)
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<ArchiveIndexed, object>(x => DataFormat.GetKillCount(x.Archive))">
                @I18N.WebUILocal.KillCount
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            @I18N.WebUILocal.Result
        </MudTh>
        <MudTh>
            @I18N.WebUILocal.ToolBar
        </MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context!.Index</MudTd>
        <MudTd>@context!.Archive.Side</MudTd>
        <MudTd>@DataFormat.GetMapNameLocal(context!.Archive)</MudTd>
        <MudTd>@DataFormat.FromDateTimeSeconds(context!.Archive.CreateTime)</MudTd>
        <MudTd>@context!.Archive.PreRaidValue</MudTd>
        <MudTd>@context!.Archive.EquipmentValue</MudTd>
        <MudTd>@context!.Archive.GrossProfit</MudTd>
        <MudTd>@context!.Archive.CombatLosses</MudTd>
        <MudTd>@DataFormat.GetNetProfit(context!.Archive)</MudTd>
        <MudTd>@DataFormat.GetKillCount(context!.Archive)</MudTd>
        <MudTd>@DataFormat.GetResultStr(context!.Archive)</MudTd>
        <MudTd Style="display: flex; align-content: center">
            <MudStack Row="true">
                <MudButton Variant="Variant.Text" Color="Color.Info"
                           Onclick="@(() => LookDetails(context!))">
                    @I18N.WebUILocal.Info
                </MudButton>
                <MudButton Variant="Variant.Text" Color="Color.Success"
                           Onclick="@(() => LookQuickEquip(context!))">
                    @I18N.WebUILocal.QuickEquip
                </MudButton>
            </MudStack>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager RowsPerPageString="@I18N.WebUILocal.TablePagerRowsPerPageString" InfoFormat="@I18N.WebUILocal.TablePagerInfoFormat"
                       PageSizeOptions="new[] { 10, 1, 5, 20, 50, 100 }"/>
    </PagerContent>
</MudTable>

<MudOverlay @bind-Visible="_visible" DarkBackground="true" AutoClose="true">
    <MudContainer @onclick:stopPropagation="true" Style="background-color: white">
        <MudText Typo="Typo.h5">@I18N.WebUILocal.QuickEquip</MudText>
        <MudText Typo="Typo.inherit">@I18N.WebUILocal.ClickOtherZoneToClose</MudText>
        @if (QuickEquipArchive is null)
        {
            <MudText>@I18N.WebUILocal.ChoiceArchiveNotExist</MudText>
        }
        else
        {
            <QuickEquipmentWidget Archive="QuickEquipArchive" ProvideQuickBuy="@true"/>
        }

        @code
        {
            public RaidArchive? QuickEquipArchive;
        }
    </MudContainer>
</MudOverlay>

@code {
    private bool _visible;
    private bool _jump2DetailPage;
    
    /// <summary>
    /// 显示/隐藏 overlay
    /// </summary>
    public void ToggleOverlay(bool value)
    {
        _visible = value;
    }
    
    public ArchiveIndexed? SelectedArchiveIndexed { get; set; }
    public List<ArchiveIndexed> RaidArchiveIndexedAll => GetArchiveIndexedAll();

    private List<ArchiveIndexed> GetArchiveIndexedAll()
    {
        try
        {
            List<ArchiveIndexed> archivesIndexed = DataGetter.GetArchivesIndexed(WebData.CurrAccount);
            archivesIndexed.Reverse();
            return archivesIndexed;
        }
        catch (Exception e)
        {
            ModConfig.Warn($"获取战绩索引列表时出现错误: {e.Message}");
            return [];
        }
    }

    /// <summary>
    /// 查看战绩详情
    /// </summary>
    public void LookDetails(ArchiveIndexed archiveIndexed)
    {
        try
        {
            if (WebData.LookingServerIds.Add(archiveIndexed))
            {
                Snackbar.Add(I18N.DumpFormatStrLocal(I18N.WebUILocal.AddInfoTabSuccess, new { archiveIndexed.Index, archiveIndexed.Archive.ServerId }));
                if (_jump2DetailPage) Navigation.NavigateTo("/RaidRecord/Info", true);
            }
            else
            {
                Snackbar.Add(I18N.DumpFormatStrLocal(I18N.WebUILocal.AddInfoTabFail, new { archiveIndexed.Index, archiveIndexed.Archive.ServerId }));
            }
        }
        catch (Exception e)
        {
            ModConfig.Warn($"查看战绩详情时出现错误: {e.Message}");
        }
    }
    
    /// <summary>
    /// 查看快速购买界面
    /// </summary>
    public void LookQuickEquip(ArchiveIndexed archiveIndexed)
    {
        try
        {
            QuickEquipArchive = archiveIndexed.Archive;
            ToggleOverlay(true);
        }
        catch (Exception e)
        {
            ModConfig.Warn($"查看快速购买界面时出现错误: {e.Message}");
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        if (string.IsNullOrEmpty(WebData.CurrAccount))
        {
            Navigation.NavigateTo("/RaidRecord", true);
        }
    }
}