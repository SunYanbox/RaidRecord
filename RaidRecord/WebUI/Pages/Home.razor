@page "/RaidRecord"
@using System.Collections.ObjectModel
@using SPTarkov.Server.Core.Controllers
@using SPTarkov.Server.Core.Models.Common
@using SPTarkov.Server.Core.Models.Eft.Profile
@using SPTarkov.Server.Core.Servers

@inject I18NMgr I18NMgr
@inject ModConfig ModConfig;
@inject SaveServer SaveServer;
@inject WebDataContext WebData;
@inject RecordManager RecordManager
@inject DataGetterService DataGetter;
@inject LauncherController LauncherController;

<MainLayout/>

<MudSelect @bind-Value="WebData.CurrAccount"
           Style="width: auto"
           Label="@("webUI.choiceProfile".Translate(I18NMgr.I18N!))"
           AdornmentColor="Color.Secondary">
    @foreach (MongoId account in AccountAllExist)
    {
        <MudSelectItem Value="@account.ToString()">@($"{account} {GetName(account)} {RecordManager.GetRecordFileSize(account)}")</MudSelectItem>
    }
</MudSelect>

<ProfileInfoWidget SptProfile="GetCurrSptProfile()"></ProfileInfoWidget>

@code {
    private string GetName(MongoId session)
    {
        Info? info = LauncherController.Find(session);
        return info != null ? $"{info.Username}" : string.Empty;
    }

    private ReadOnlySet<MongoId> AccountAllExist => DataGetter.GetAllAccounts();

    private SptProfile? GetCurrSptProfile()
    {
        if (!MongoId.IsValidMongoId(WebData.CurrAccount)) return null;
        try
        {
            return SaveServer.GetProfile(WebData.CurrAccount);
        }
        catch (Exception e)
        {
            ModConfig.Warn($"无法获取到{WebData.CurrAccount}的存档信息: {e.Message}");
            return null;
        }
    }

    /// <summary>
    /// 默认初始化为历史战绩最多的账号
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(WebData.CurrAccount)) return;
        MongoId? choice = null;
        int recordsCount = 0;
        foreach (MongoId mongoId in AccountAllExist)
        {
            int count = (await DataGetter.GetArchivesBySession(mongoId)).Count;
            if (count <= recordsCount) continue;
            recordsCount = count;
            choice = mongoId;
        }
        if (!string.IsNullOrEmpty(choice?.ToString()))
        {
            WebData.CurrAccount = choice.ToString()!;
        }
    }
}