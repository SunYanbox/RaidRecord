@page "/RaidRecord/Info"

@inject I18NMgr I18NMgr
@inject ModConfig ModConfig
@inject WebDataContext WebData
@inject DataFormatService DataFormat
@inject DataGetterService DataGetter
@inject NavigationManager Navigation

<MainLayout/>

<MudDynamicTabs Color="@Color.Info" Style="height: 100%; width: 100%;" AddTab="@OnAddTab" CloseTab="@OnCloseTab">
    @if (WebData.LookingServerIds.Count == 0)
    {
        <MudText Color="Color.Error">@I18NMgr.WebUILocal.NoArchiveWarn</MudText>
    }
    else
    {
        @foreach (ArchiveIndexed archiveIndexed in WebData.LookingServerIds)
        {

            <MudTabPanel Text="@($"Index {archiveIndexed.Index}")" ToolTip="@archiveIndexed.Archive.ServerId"
                         ShowCloseIcon="@true">
                @try
                {
                    <ArchiveInfoPaperWidget Archive="archiveIndexed.Archive"/>
                }
                catch (Exception e)
                {
                    <MudText Color="Color.Error">显示存档标签失败: @e.Message</MudText>
                }
            </MudTabPanel>
        }
    }
</MudDynamicTabs>

<MudMessageBox @ref="MudMessageBox" Title="Info" CancelText="@I18NMgr.WebUILocal.Cancel">
    <MessageContent>
        <MudText>@(I18NMgr.WebUILocal.InputIndexUWantLook):</MudText>
        <MudNumericField @bind-Value="_index" Variant="Variant.Text" Min="0" Max="@GetMaxCount()"/>
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.Commit"
                   OnClick="@(() => AddTab(_index))">@I18NMgr.WebUILocal.Confirm
        </MudButton>
    </YesButton>

    @code
    {
        int _index;
    }
</MudMessageBox>

@code {
    public required MudMessageBox MudMessageBox;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        if (string.IsNullOrEmpty(WebData.CurrAccount))
        {
            Navigation.NavigateTo("/RaidRecord", true);
        }
    }

    private int GetMaxCount()
    {
        try
        {
            return string.IsNullOrEmpty(WebData.CurrAccount)
                ? 0
                : DataGetter.GetArchivesBySession(WebData.CurrAccount).Result.Count - 1;
        }
        catch (Exception e)
        {
            ModConfig.Warn($"获取可选索引最大值失败: {e.Message}");
            return 0;
        }
    }

    private void AddTab(int index)
    {
        try
        {
            WebData.LookingServerIds.Add(new ArchiveIndexed(DataGetter.GetArchiveWithIndex(index, WebData.CurrAccount), index));
        }
        catch (Exception e)
        {
            ModConfig.Warn($"创建索引 {index} 对局详情失败: {e.Message}");
        }
    }

    private async Task OnAddTab()
    {
        await MudMessageBox.ShowAsync();
    }

    private void OnCloseTab(MudTabPanel panel)
    {
        WebData.LookingServerIds.RemoveWhere(x => x.Index.ToString() == panel.Text?.Replace("Index ", ""));
    }
}