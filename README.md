# RaidRecord

一款用于记录离线版塔克夫战绩的模组

## 更新日志

### 0.6.5

新增
- 新增`price`指令, 用于搜索物品价值; 允许通过tpl精确搜索; 或者通过名字模糊搜索
  > 如果名字中含有空格, 需要使用一对英文半角双引号双引号包含, 例如`price name "45mm SSA"`
  > 同时最后且只有最后一个双引号允许缺省, 例如`price name "45mm SSA`

修改
- 允许的误差改为1e-9
- 使用RagfairController中的方式重构价格计算逻辑
- 重构了StringUtil.SplitCommand以支持在参数中包含带有空格的字符串
- PriceSystem提供的用到缓存的函数, 已更名以使得函数名更清晰
- 将`RaidRecord/RaidRecord.cs`中注册ChatBot的代码移动到RaidRecordManagerChat中, 从属关系更明确

优化
- 优化价格计算逻辑
- 优化指令系统, 参数内需要包含空格时, 可以通过一对英文半角双引号包含, 例如`items name "45mm SSA"`

修复
- 修复了`items`指令使用ShortName导致一些物品显示信息不明显的问题
- 修复了价格计算偶尔过低的问题
- 修复了输出注册ChatBot的本地化日志时, 本地化系统还未加载的问题

### 0.6.4

新增
- 新增设置选项`autoUnloadOtherLanguages`: 默认为true, 当为true时, 模组将自动卸载其他不使用的语言的数据
  > 例如: 你当前语言是en, 将加载完成后将删除除了en和ch(出错回退语言)外其他所有语言的数据
- 新增设置选项`priceCacheUpdateMinTime`: 默认为6min, 控制新版价格缓存持有时间
- info中新增击杀数量与爆头率信息
- list显示时进行了一定程度的格式化, 提升可视性

更改
- 重构了价格计算逻辑, 改为 合理的市场报价的三均值--回退-->手册/prices.json的价格
- 重构了本地化逻辑, 目的是让翻译文件的键更直观
- 将ItemUtil从静态类改为依赖注入类, 降低其函数参数对ItemHelper的依赖
- 将RecordCacheManager更名为RecordManager
- 提取info与items指令共有的部分为对局元数据信息
- 将LocalizationManager类重命名为I18N
> 因为写`LocalizationManager`写的我难受, 专门搜了个短的表示国际化的词代替

优化
- 优化了价格计算与缓存逻辑, 默认每条价格缓存6min
- 优化了本地化获取译文的方式
- 优化了本地语言包多了后对内存的占用
- 优化了list命令显示的文本
- 优化了info显示的信息
- SPT相关的数据库, 获取后的变量名称附带`spt`前缀

修复
- `info`与`items`命令移除使用`ServerId`获取对局的方式, 命令中index依然是可选参数, 但不输入默认为-1
- 修复了部分地图名称没有正确使用本地化描述的问题
- 修复了击杀者信息显示部位错误的问题

> 未本地化的剩下的那几个一直没遇到过, 先不翻译了

### 0.6.3

新增
- items指令新增 mode 参数支持 change/all 模式切换物品显示
- 新增 GetParameter<T> 泛型方法，支持从参数字典中安全提取并转换值
- 新增通过 serverId 和 index 精确查找对局存档的功能
- 新增独立的 UpdateItemsChanged 方法，用于统一处理物品变更检测逻辑
- 聊天机器人命令执行流程中新增异常捕获机制，提升稳定性
- 对局开始与结束时补充信息用于辅助判断模组能否正确记录带入带出物品的数据

更改
- 将RaidInfo中的突袭开始和结束处理方法移至RaidUtil工具类
- 新增RaidUtil类统一管理突袭相关的业务逻辑
- 重构了命令系统
- 限制所有储存的命令参数为小写, 以支持客户端可以大小写任意输入
- 重构命令类中的参数解析逻辑，统一调用新工具方法以提高复用性
- 所有命令参数名在解析前统一转为小写，增强命令兼容性与容错能力
- 对局结束获取物品时将不再从Resuts.Profile中获取, 此处疑似是对局开始的存档数据

优化
- 优化物品变更信息的显示格式：限制描述长度、对齐数值列，显著提升可读性
- 简化物品变更检测流程，逻辑更清晰，性能更高效
- 调整物品详情格式化输出，增强可读性
- 修改物品带入带出信息显示格式，明确标示价格计算方式

移除
- 命令系统中移除了`CommandCallback`委托, 改为基于抽象类与派生了实现执行命令
- 移除多处重复的物品变更集合（add/remove/change）清理代码，减少冗余

### 0.6.2

新增
- 通过局内ChatBot获取信息时, 当信息超过一条后会显示当前发送的条数与剩余条数, 这些信息结束位置会显示他们对应的消息列表的开头的一些字符, 用来标记消息所属的信息
- 游戏开始或结束时, 输出信息, 用于判断是否正确记录对局信息
- 支持Scav模式了

变化
- 重构了对局记录的数据结构
- 进行了完整的代码清理与格式化, 优化了代码风格
- 实现了除了命令相关的那些函数外绝大部分非空引用判断
- 部分引用为空时显示错误信息, 方便追踪与报告可能的错误
- `InjectableClasses`由手动注入依赖改为主构造函数注入
- 移除了当战局是Scav时抛出异常的逻辑, 支持Scav模式的战斗记录数据
- 修改 RecordCacheManager 以支持按账户 ID 管理数据
- 修改了RaidRecordManagerChat各个指令获取存档的逻辑, 以获取正确存档

优化
- 优化了长消息接受体验
- 移除了不使用的变量, 移除了冗余初始化
- 使用依赖注入降低了手动解析依赖的风险, 简化了获取依赖的代码
- 优化物品价格计算和库存信息获取方法, 使用类似`InRaidHelper.SetInventory`中的方式

修复
- 修复了无法查看未知结果(中途退出)的战绩详情的问题
- 修复无法把输出目录的dll文件正确拷贝到SPT目录的问题
- 修复了部分错误变量命名规范未清理的问题

已知问题
- ~~游戏开始时info.ServerId意外为null(已修复)~~
- 正常游戏流程下偶现游戏结束时没有发现任何已经开始的对局数据(发现是因为SPT偶尔会处理两次请求, 导致第二次没有数据)
- 暂时不支持跟踪**转移**相关的物品的价值
- 新版本部分信息与报错没有做多语言处理

计划
- 考虑使用资源`.resx`进行多语言支持
- ~~重构RaidInfo相关的成员函数, 降低其对部分参数的依赖和耦合~~
- 重构命令系统, 降低RaidRecordManagerChat的代码长度, 分解相关的代码
- 优化items指令, 或新添更多有用的指令
- 支持**转移**相关的物品的跟踪

### 0.6.1
- 兼容过去版本(0.5.0)的数据库(即db文件夹下所有文件)
- 修复了0.6.0版本大量命令失效的错误
- 迁移0.5.0的代码到新命名空间结构

计划
- 使用新代码风格进行代码清理
- 完善空引用判断
- 完善更详细的日志

已知问题
- ~~未知结果(中途退出)的战绩查看info时没有处理空引用问题~~

### 0.6.0
- 从[RaidRecordOutdated](https://github.com/SunYanbox/raidrecordOutdated)迁移过来
- ~~兼容过去版本(`raidrecord-v0.5.0bate-0.5.0`等)的数据库(即db文件夹下所有文件)~~
- 不兼容模组文件夹名称, 不兼容模组dll文件名称
- 新版本默认使用RaidRecord作为模组文件夹名称与dll文件名称, 方便未来覆盖式更新
